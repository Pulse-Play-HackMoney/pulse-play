## Phase 1 Complete: Monorepo + LMSR Engine + Market Manager + Position Tracker
Date: 2026-02-04

### What was done:
1. **Monorepo scaffolding** — pnpm workspaces with root package.json, pnpm-workspace.yaml, tsconfig.base.json, .gitignore
2. **packages/hub** — TypeScript + Jest setup with ts-jest
3. **LMSR Engine** (`packages/hub/src/modules/lmsr/`)
   - `types.ts` — Outcome type
   - `engine.ts` — Stateless LMSR functions: costFunction, getPrice, getCost, getShares (binary search inverse), getNewQuantities
   - Uses log-sum-exp trick for numerical stability with large quantities
   - `engine.test.ts` — 23 tests covering prices, costs, shares, quantities, b-sensitivity
4. **Market Manager** (`packages/hub/src/modules/market/`)
   - `types.ts` — Market, MarketStatus, ResolutionResult types
   - `manager.ts` — State machine (PENDING→OPEN→CLOSED→RESOLVED), market CRUD, resolution with position-based winner/loser calculation
   - `manager.test.ts` — 21 tests covering creation, valid transitions, invalid transitions, timestamps, resolution logic
5. **Position Tracker** (`packages/hub/src/modules/position/`)
   - `types.ts` — Position type
   - `tracker.ts` — In-memory position storage with market/user/specific queries and cleanup
   - `tracker.test.ts` — 10 tests covering add, query, clear

### Test results:
- **54 tests passing** across 3 test suites
- Command: `pnpm --filter hub test`

### Architecture decisions:
- LMSR engine is purely stateless functions (no class) — easy to test and compose
- MarketManager is a class holding market state in a Map — supports multiple markets
- PositionTracker is a class with in-memory array — simple and sufficient for MVP
- Market resolution takes positions as a parameter (loose coupling with PositionTracker)
- Binary search for getShares inverse (100 iterations, 1e-10 tolerance)

### Tech stack so far:
- pnpm 10.x workspaces
- TypeScript 5.6
- Jest 29 + ts-jest 29
- Node 20+

---

## Phase 2 Complete: Yellow Network / Clearnode Integration
Date: 2026-02-04

### What was done:
1. **Dependencies added** — @erc7824/nitrolite@^0.5.3, viem@^2.45.1, ws@^8.19.0, @types/ws
2. **Clearnode module** (`packages/hub/src/modules/clearnode/`)
   - `types.ts` — ClearnodeConfig, SubmitAppStateParams, CloseSessionParams, TransferParams, AppSessionAllocation
   - `rpc.ts` — sendAndWait() promise-based WebSocket correlator (adapted from yellow-quickstart)
   - `auth.ts` — 3-step EIP-712 auth flow: auth_request → auth_challenge → auth_verify
   - `faucet.ts` — requestFaucet() HTTP helper for sandbox token distribution
   - `client.ts` — ClearnodeClient class: connect, disconnect, isConnected, getBalance, requestFaucet, submitAppState, closeSession, transfer
   - `rpc.test.ts` — 6 tests (send, resolve, ignore, error, timeout, concurrent)
   - `auth.test.ts` — 6 tests (request, challenge, verify, signer return, request fail, verify fail)
   - `client.test.ts` — 24 tests (connection lifecycle 6, getBalance 4, faucet 2, submitAppState 4, closeSession 4, transfer 4)
   - `client.live.test.ts` — 6 live tests gated by LIVE_TEST=true (auth, faucet, balance, disconnect)
3. **Jest config updated** — Added moduleNameMapper to resolve .js imports for ESM-style TypeScript

### Test results:
- **90 mock tests passing** across 6 test suites
- **6 live tests skipped** (run with LIVE_TEST=true pnpm --filter hub test)
- Command: `pnpm --filter hub test`

### Architecture decisions:
- ClearnodeClient wraps all Clearnode operations behind a clean interface
- Auth flow generates ephemeral session keys (lightweight ECDSA for repeated RPC calls)
- sendAndWait correlates request/response by RPC method name, handles errors and timeouts
- Faucet is a standalone helper (reusable for bettor funding in Phase 3)
- Live tests use throwaway ephemeral wallets against sandbox — no cleanup needed
- Module imports use .js extensions (ESM convention) with Jest moduleNameMapper for resolution

### How PulsePlay uses these operations:
- Fund MM (test): requestFaucet()
- Bet rejected: closeSession() — return funds to user
- Loser resolution: submitAppState() (reallocate user→MM) → closeSession()
- Winner resolution: closeSession() (return bet) → transfer() (pay profit from MM→user)
- Check liquidity: getBalance() — MM's available funds

### Next steps (Phase 3):
- Hub REST + WebSocket APIs (Fastify)
- POST /api/bet, GET /api/market, POST /api/oracle/*, POST /api/faucet/*
- WebSocket broadcast for real-time odds/market updates
- Mock Oracle with auto-play mode
- Wire LMSR + Market + Position + Clearnode into API endpoints

---

## Phase 3 Complete: Hub REST + WebSocket APIs
Date: 2026-02-04

### What was done:
1. **Dependencies added** — fastify, @fastify/websocket
2. **API types** (`src/api/types.ts`) — Request/response DTOs, WebSocket message type unions (ODDS_UPDATE, MARKET_STATUS, GAME_STATE, BET_RESULT)
3. **OracleService** (`src/modules/oracle/`) — Game state management, auto-play mode with configurable timers and outcome sequences, callbacks for market lifecycle
4. **WsManager** (`src/api/ws.ts`) — WebSocket connection tracking with per-address mapping, broadcast(), sendTo(), cleanup on close
5. **AppContext** (`src/context.ts`) — Shared context interface + createTestContext() helper with mocked ClearnodeClient
6. **App factory** (`src/app.ts`) — buildApp(ctx) creates Fastify instance with all routes and WebSocket support
7. **Routes:**
   - `bet.routes.ts` — POST /api/bet (LMSR integration: getShares → getNewQuantities → updateQuantities → record position → broadcast odds)
   - `market.routes.ts` — GET /api/market, GET /api/market/:marketId (with computed LMSR prices)
   - `positions.routes.ts` — GET /api/positions/:address
   - `oracle.routes.ts` — POST /api/oracle/game-state, /market/open, /market/close, /outcome (full lifecycle with WS broadcasts + individual BET_RESULT messages)
   - `faucet.routes.ts` — POST /api/faucet/user (stub), POST /api/faucet/mm (calls ClearnodeClient)
   - `admin.routes.ts` — GET /api/admin/state, POST /api/admin/reset
8. **Server entry point** (`src/server.ts`) — Creates real context from env vars and listens on PORT

### Test results:
- **184 tests passing** across 15 test suites (90 existing Phase 1+2 + 94 new Phase 3)
- 6 live Clearnode tests skipped (run with LIVE_TEST=true)
- Integration tests use real WebSocket connections (app.listen on port 0)
- All route tests use Fastify's app.inject() — no port binding needed

### Test breakdown (Phase 3 new — 94 tests):
- oracle.test.ts: 11 (game state, auto-play, timers)
- ws.test.ts: 8 (broadcast, sendTo, cleanup, clear)
- bet.routes.test.ts: 15 (validation, LMSR integration, WS broadcast)
- market.routes.test.ts: 8 (prices, states, by-ID lookup)
- positions.routes.test.ts: 5 (query, filtering, field completeness)
- oracle.routes.test.ts: 23 (game state, open/close/resolve, WS notifications, BET_RESULT delivery)
- faucet.routes.test.ts: 6 (stub, validation, ClearnodeClient integration)
- admin.routes.test.ts: 6 (state dump, reset, auto-play stop)
- integration.test.ts: 12 (full lifecycle, concurrent bets, real WS, market cycling)

### Architecture decisions:
- AppContext is a mutable object — admin reset replaces MarketManager/PositionTracker instances in-place
- Oracle module-level marketCounter generates sequential market IDs (resettable for tests)
- WsManager uses readyState === 1 (numeric) to avoid import dependency on WebSocket constant
- Integration tests track open sockets and close them in afterEach to prevent worker leaks
- Route handlers return response objects directly (Fastify serializes to JSON automatically)

### Next steps (Phase 4):
- Frontend scaffolding (Next.js 14)
- Connect to Hub WebSocket for real-time updates
- Betting UI with LMSR price display
- Game state visualization

---

## Phase 4 Complete: Frontend Core
Date: 2026-02-04

### What was done:
1. **Next.js 14 scaffolding** — Created @pulse-play/frontend package with TypeScript, Tailwind, App Router
2. **Jest + testing-library setup** — Mock modules for wagmi, viem, @tanstack/react-query, WebSocket
3. **Lib modules** (`src/lib/`)
   - `config.ts` — env var exports (HUB_REST_URL, HUB_WS_URL, PRIVATE_KEY)
   - `types.ts` — mirrors hub API types (MarketResponse, PositionsResponse, WsMessage, etc.)
   - `api.ts` — Hub REST client (placeBet, getMarket, getPositions, oracle endpoints)
4. **Providers** (`src/providers/`)
   - `WagmiProvider.tsx` — wagmi config + QueryClient + WalletContext (address derived from PRIVATE_KEY)
   - `WebSocketProvider.tsx` — WebSocket connection management, subscribe pattern for real-time updates
   - `MarketProvider.tsx` — Market state management, syncs with REST + WebSocket
5. **Hooks** (`src/hooks/`)
   - `useBet.ts` — Bet placement with loading/error states
   - `usePositions.ts` — Position fetching with auto-refetch on market resolution
   - `useMarket.ts`, `useWebSocket.ts` — barrel re-exports
6. **Shared Components** (`src/components/`)
   - `Header.tsx` — Logo, navigation (Bettor/Oracle), WebSocket status, WalletStatus
   - `WalletStatus.tsx` — Shows truncated address or "not configured"
7. **Bettor Components** (`src/components/bettor/`)
   - `OddsDisplay.tsx` — Ball/Strike prices as percentages + American odds
   - `BetForm.tsx` — Outcome selection, amount input with presets, place bet button
   - `PositionList.tsx` — Shows user's positions in current market
   - `BetResultToast.tsx` — Win/Loss notification from WebSocket BET_RESULT
8. **Oracle Components** (`src/components/oracle/`)
   - `GameControls.tsx` — Activate/Deactivate game toggle
   - `MarketControls.tsx` — Open/Close market, Resolve with Ball/Strike
   - `StateDisplay.tsx` — System state dashboard (market, positions, connections)
9. **App Pages** (`src/app/`)
   - `layout.tsx` + `LayoutInner.tsx` — Provider nesting (WagmiProvider > WebSocketProvider > MarketProvider)
   - `page.tsx` — Bettor view (OddsDisplay, BetForm, PositionList)
   - `oracle/page.tsx` — Oracle panel (GameControls, MarketControls, StateDisplay)
10. **Hub CORS** — Added @fastify/cors to hub for frontend cross-origin requests

### Test results:
- **67 tests passing** across 15 test suites
- Command: `pnpm --filter @pulse-play/frontend test`
- Build passes: `pnpm --filter @pulse-play/frontend build`

### Test breakdown (67 tests):
- lib/api: 9
- providers: 12 (WagmiProvider 3, WebSocketProvider 4, MarketProvider 5)
- hooks: 10 (useBet 5, usePositions 5)
- components/shared: 6 (Header 3, WalletStatus 3)
- components/bettor: 17 (OddsDisplay 4, BetForm 5, PositionList 4, BetResultToast 4)
- components/oracle: 13 (GameControls 4, MarketControls 5, StateDisplay 3)

### Architecture decisions:
- WagmiProvider uses viem's privateKeyToAccount for direct wallet; no connector dependencies
- WebSocket reconnects after 3 seconds on disconnect
- MarketProvider refetches on OPEN/RESOLVED status changes (not CLOSED)
- BetResultToast uses subscribe pattern to avoid prop drilling
- All components have data-testid attributes for testing
- Test mocks for wagmi/viem/react-query avoid ESM import issues in Jest

### Environment setup:
- Copy `.env.local.example` to `.env.local`
- Set `NEXT_PUBLIC_PRIVATE_KEY` to a test wallet private key

### Running the full stack:
1. Terminal 1: `pnpm --filter hub build && node packages/hub/dist/server.js`
2. Terminal 2: `pnpm --filter @pulse-play/frontend dev`
3. Open http://localhost:3000 (Bettor) or http://localhost:3000/oracle (Oracle)

### Next steps (Phase 5):
- Remaining personas (Bettor wallet connection, proper session management)
- E2E integration tests
- Demo polish

---

## MetaMask Wallet Connection with Environment Toggle
Date: 2026-02-05

### What was done:
1. **Config update** (`packages/frontend/src/lib/config.ts`)
   - Added `WalletMode` type ('metamask' | 'private-key')
   - Added `WALLET_MODE` export from `NEXT_PUBLIC_WALLET_MODE` env var (default: 'private-key')

2. **Jest mock for wagmi/connectors** (`src/test/mocks/wagmiConnectors.ts`)
   - New mock file with `injected()` connector export

3. **Jest config update** (`jest.config.js`)
   - Added `'^wagmi/connectors$'` module mapping

4. **wagmi mock update** (`src/test/mocks/wagmiModule.ts`)
   - Added test utilities: `__setMockAccountState`, `__setMockConnectFn`, `__setMockDisconnectFn`, `__resetMocks`
   - Imports injected connector from wagmiConnectors mock

5. **WagmiProvider refactor** (`src/providers/WagmiProvider.tsx`)
   - Extended WalletContextValue interface with: `mode`, `isConnecting`, `isConnected`, `connect`, `disconnect`
   - Added `WalletContextProviderInner` component that uses wagmi hooks (useAccount, useConnect, useDisconnect)
   - Conditional logic: MetaMask mode uses wagmi hooks, private-key mode uses static account
   - Connect finds injected connector and calls wagmi connect
   - Provider nesting: WagmiProviderBase → QueryClientProvider → WalletContextProviderInner

6. **WalletStatus update** (`src/components/WalletStatus.tsx`)
   - MetaMask mode, not connected: Shows "Connect Wallet" button
   - MetaMask mode, connecting: Shows "Connecting..." disabled button
   - MetaMask mode, connected: Shows address + "Disconnect" button
   - Private-key mode: Keeps existing behavior (no connect/disconnect buttons)

7. **Tests updated**
   - `WagmiProvider.test.tsx`: 6 tests for new context fields and behaviors
   - `WalletStatus.test.tsx`: Expanded to 11 tests covering both modes

8. **Environment documentation** (`.env.local.example`)
   - Documented `NEXT_PUBLIC_WALLET_MODE` with mode options

### Test results:
- **77 tests passing** across 15 test suites (was 67)
- Command: `pnpm --filter @pulse-play/frontend test`

### Breaking changes:
- None — `useWallet()` remains backwards compatible
- `address` and `isConfigured` still work as before
- New fields (`mode`, `isConnecting`, `isConnected`, `connect`, `disconnect`) added with sensible defaults

### Usage:
```bash
# Private-key mode (default) - existing behavior
NEXT_PUBLIC_WALLET_MODE=private-key
NEXT_PUBLIC_PRIVATE_KEY=0x...

# MetaMask mode - browser wallet connection
NEXT_PUBLIC_WALLET_MODE=metamask
```

### Notes:
- Module-level config evaluation means WALLET_MODE is read once at import time
- MetaMask mode tests would require Jest module isolation (complex), so coverage is via integration testing
- WagmiProvider test file simplified to avoid react multiple-instance issues with jest.doMock


### Build fix:
- Changed import from `wagmi/connectors` to main `wagmi` export for `injected` connector
- `wagmi/connectors` barrel imports porto module which has missing peer dependency
- Removed separate wagmiConnectors.ts mock file (injected now in wagmiModule.ts)
- Removed `^wagmi/connectors$` mapping from jest.config.js


---

## Terminal Developer Dashboard
Date: 2026-02-05

### What was done:
1. **New package created** — `@pulse-play/dashboard` with Ink + React for terminal UI
2. **Package dependencies** — ink@^4.4.1, ink-spinner@^5.0.0, react@^18.2.0, chalk@^5.3.0, ws@^8.19.0
3. **Hooks** (`src/hooks/`)
   - `useWebSocket.ts` — WebSocket connection with auto-reconnect (3s delay, max 10 attempts)
   - `useAdminState.ts` — REST polling for `/api/admin/state` and `/api/admin/positions/:marketId`
4. **Components** (`src/components/`)
   - `MarketPanel.tsx` — Market status, LMSR prices with American odds
   - `PositionsPanel.tsx` — Position list with truncated addresses
   - `EventLog.tsx` — Scrolling WebSocket event log with timestamps
   - `SystemInfo.tsx` — WS/API status, client count, game state
5. **Main App** (`src/App.tsx`)
   - 2-column layout with border boxes
   - Aggregates state from hooks
   - 'q' keypress to quit
6. **Entry point** (`src/index.tsx`)
   - CLI argument parsing for custom hub URL
   - Help flag support
   - Shebang for direct execution
7. **Formatters** (`src/utils/formatters.ts`)
   - formatOdds, formatAmericanOdds, truncateAddress, formatTime
   - formatWsMessage, getStatusColor, getOutcomeColor
   - formatDollars, formatShares
8. **Hub enhancement** — Added `GET /api/admin/positions/:marketId` endpoint to admin.routes.ts

### Test results:
- **23 dashboard tests** (all formatters)
- **187 hub tests** (was 184, +3 new admin position endpoint tests)
- Command: `pnpm --filter @pulse-play/dashboard test`

### Test breakdown (dashboard — 23 tests):
- formatOdds: 5
- formatAmericanOdds: 4
- truncateAddress: 2
- formatTime: 1
- formatWsMessage: 6
- getStatusColor: 1
- getOutcomeColor: 2
- formatDollars: 1
- formatShares: 1

### Running the dashboard:
```bash
# Terminal 1: Start hub
cd packages/hub && pnpm dev

# Terminal 2: Start dashboard
cd packages/dashboard && pnpm dev

# Or with custom URL
cd packages/dashboard && pnpm dev http://192.168.1.100:3001
```

### Architecture notes:
- Dashboard is a separate CLI process (not in-process with hub)
- Connects via WebSocket for real-time events, polls REST for state
- LMSR price calculation duplicated in App.tsx for local updates from polled state
- Event log is capped at 100 entries (FIFO)
- Positions panel shows max 5 positions

### Next steps:
- Live integration testing with hub
- E2E verification of full stack (hub + frontend + dashboard)

### Test fixes (during dashboard implementation):
- Fixed `BetForm.test.tsx` — changed `'Ball'` to `'BALL'` (uppercase as per types.ts)
- Fixed `MarketControls.test.tsx` — changed `'Ball'` to `'BALL'` (uppercase as per types.ts)
- These were pre-existing bugs from a previous outcome terminology refactor

### Final test counts:
- **Hub**: 189 passed (6 live tests skipped)
- **Frontend**: 77 passed
- **Dashboard**: 23 passed
- **Total**: 289 passing tests


---

## Dashboard Refactor: Polling → WebSocket
Date: 2026-02-05

### Problem
The dashboard was polling `/api/admin/state` every 1 second, filling backend logs unnecessarily.

### Solution
Replaced REST polling with WebSocket-based state synchronization.

### New WebSocket Message Types (hub/src/api/types.ts)
1. **POSITION_ADDED** — Broadcast when a bet creates a position
   - Contains full position object + total position count
2. **CONNECTION_COUNT** — Broadcast on connect/disconnect
   - Contains current count of WebSocket clients
3. **STATE_SYNC** — Sent to newly connected clients
   - Contains full AdminStateResponse + positions array

### Hub Changes
- `types.ts` — Added 3 new WsMessage types, updated union type
- `ws.ts` — Added broadcastConnectionCount() on connect/disconnect, added sendToSocket() method
- `app.ts` — Send STATE_SYNC to new WebSocket connections
- `bet.routes.ts` — Broadcast POSITION_ADDED after recording position

### Dashboard Changes
- `types.ts` — Mirrored new WsMessage types
- `App.tsx` — Completely refactored to derive state from WebSocket messages:
  - STATE_SYNC initializes full state on connect
  - POSITION_ADDED adds to positions list
  - CONNECTION_COUNT updates client count
  - MARKET_STATUS/GAME_STATE/ODDS_UPDATE update respective state
  - Removed useAdminState import and REST polling
- `index.tsx` — Removed restUrl prop (no longer needed)
- `formatters.ts` — Added formatting for new message types
- `hooks/index.ts` — Removed useAdminState export (deprecated)

### Test Updates
- `ws.test.ts` — Updated 8 tests to account for CONNECTION_COUNT broadcasts, added 4 new tests
- `formatters.test.ts` — Added 3 tests for new message type formatting

### Test Results
- **Hub:** 192 passed (was 187, +5 new WS tests)
- **Frontend:** 77 passed
- **Dashboard:** 26 passed (was 23, +3 formatter tests)
- **Total:** 295 passing tests

### Benefits
- No more polling logs in backend
- Real-time state updates via WebSocket
- Lower backend load
- Simpler dashboard architecture (single data source)

---

## Frontend Refactor: StateDisplay Polling → WebSocket
Date: 2026-02-05

### Problem
The frontend's StateDisplay component (Oracle view) was polling `/api/admin/state` every 5 seconds, duplicating the same issue that was fixed in the dashboard.

### Solution
Extended the frontend's MarketProvider to handle all WebSocket message types and provide admin state to StateDisplay via context.

### Frontend Types Changes (src/lib/types.ts)
- Added `address` field to Position interface
- Added 3 new WebSocket message types (mirroring hub):
  - `WsPositionAdded` — position + positionCount
  - `WsConnectionCount` — count
  - `WsStateSync` — full AdminStateResponse + positions
- Updated `WsMessage` union type

### MarketProvider Changes (src/providers/MarketProvider.tsx)
- Added `positionCount` and `connectionCount` to MarketState
- Handle new WebSocket message types:
  - `STATE_SYNC` — Initialize market, prices, gameActive, positionCount, connectionCount
  - `CONNECTION_COUNT` — Update connectionCount
  - `POSITION_ADDED` — Update positionCount
- Exposed new values in context

### StateDisplay Changes (src/components/oracle/StateDisplay.tsx)
- Removed useState for market, gameState, positionCount, connectionCount
- Removed useEffect with setInterval polling
- Removed fetchState() REST function
- Now gets all state from useMarket() hook
- Same UI rendering logic preserved

### Test Fixes
- Updated all test files to use uppercase 'BALL'/'STRIKE' (was 'Ball'/'Strike'):
  - `usePositions.test.tsx` — 4 occurrences
  - `api.test.ts` — 5 occurrences
  - `MarketProvider.test.tsx` — 1 occurrence
- Added missing `address` field to Position mocks in tests

### Test Results
- **Hub:** 192 passed
- **Frontend:** 81 passed (was 77, +4 new MarketProvider context tests)
- **Dashboard:** 26 passed
- **Total:** 299 passing tests

### Benefits
- Oracle StateDisplay now updates instantly via WebSocket
- Eliminated /api/admin/state polling from frontend
- Consistent state sync architecture across dashboard and frontend
- All state flows through WebSocket → MarketProvider → components

---

## Fix: Dashboard market-id not updating & odds not resetting on new market
Date: 2026-02-05

### Bugs Fixed

**Bug 1: Dashboard market-id not updating**
- MARKET_STATUS handler in `dashboard/src/App.tsx` spread `prev.market` without updating `id`
- When market-2 opened, dashboard still showed market-1's ID

**Bug 2: Odds not resetting on new market**
- No ODDS_UPDATE broadcast when a new market opened (hub)
- Dashboard & frontend preserved old `qBall`/`qStrike` values via spread
- Old odds persisted because only bets triggered ODDS_UPDATE

### Changes

1. **Hub (`oracle.routes.ts`)** — Added `getPrice` import and ODDS_UPDATE broadcast after MARKET_STATUS in market open handler. New market now broadcasts both MARKET_STATUS(OPEN) and ODDS_UPDATE(0.5/0.5).

2. **Dashboard (`App.tsx`)** — Rewrote MARKET_STATUS handler to detect new market by comparing `prev.market.id !== msg.marketId`. When new: creates fresh market object, clears positions, resets prices to 50/50. When same market: updates status/outcome and always copies `msg.marketId`.

3. **Frontend (`MarketProvider.tsx`)** — Rewrote MARKET_STATUS handler with same new-market detection. When new market: resets qBall/qStrike/b, prices to 50/50, positionCount to 0. Always copies `message.marketId` into market state. Still triggers refetch on OPEN/RESOLVED.

### Tests Added
- Hub: +1 test — `broadcasts ODDS_UPDATE with 50/50 prices on market open`
- Frontend: +2 tests — `updates market ID when MARKET_STATUS arrives with new marketId`, `resets prices and positionCount for new market`

### Test Results
- **Hub:** 193 passed (was 192)
- **Frontend:** 83 passed (was 81)
- **Dashboard:** 26 passed (unchanged)
- **Total:** 302 passing tests

---

## Fix: Double WebSocket Connection in Frontend (StrictMode)
Date: 2026-02-05

### Root Cause
React StrictMode double-invokes effects in development: mount → unmount → mount. The cleanup function called `ws.close()`, which fired `onclose` and scheduled a reconnect via `setTimeout(connect, 3000)`. Since `reconnectTimeoutRef` was already `null` at that point, the orphaned timeout was never cleared. Result: two connections per address (one immediate from re-mount, one 3 seconds later from orphaned reconnect).

### Fix
Added `intentionalClose` closure variable in the `useEffect`. Set to `true` in the cleanup function **before** calling `ws.close()`. The `onclose` handler checks this flag and skips reconnection when the close was intentional.

### Files Changed
- `packages/frontend/src/providers/WebSocketProvider.tsx` — added `intentionalClose` guard
- `packages/frontend/src/providers/WebSocketProvider.test.tsx` — added cleanup test

### Test Results
- **Frontend:** 84 passed (was 83, +1 new cleanup test)
- **Total:** 303 passing tests

---

## Market Maker Overview Page
Date: 2026-02-05

### What was done:

#### Hub Changes
1. **types.ts** — Added `MMFaucetRequest` (optional count) and `MMInfoResponse` (address, balance, isConnected)
2. **logger.ts** — Updated `faucetMM()` signature to include count parameter; added `mmInfoFetched()` method
3. **mm.routes.ts** (new) — `GET /api/mm/info` returns MM wallet address, balance, and connection status
4. **faucet.routes.ts** — Modified `POST /api/faucet/mm` to accept `{ count?: number }` (default 1, capped at 50). Loops count times calling `requestFaucet()`. Returns partial results on mid-loop failure.
5. **app.ts** — Registered `registerMMRoutes(app, ctx)`
6. **mm.routes.test.ts** (new) — 2 tests (info endpoint success + error handling)
7. **faucet.routes.test.ts** — Added 4 new tests (count=3, no body default, count>50 rejection, partial failure)

#### Frontend Changes
1. **types.ts** — Added `MMInfoResponse` and `MMFaucetResponse` interfaces
2. **api.ts** — Added `getMMInfo()` and `requestMMFaucet(count)` functions
3. **api.test.ts** — Added 3 tests for new API functions
4. **Header.tsx** — Added "Market Maker" nav link with `data-testid="nav-market-maker"`
5. **Header.test.tsx** — Updated to verify Market Maker link presence
6. **market-maker/page.tsx** (new) — Page with 2-column grid (2/3 + 1/3): MMFaucetCard left, MMBalanceCard right. Uses refreshKey pattern for faucet→balance refresh.
7. **market-maker/MMBalanceCard.tsx** (new) — Displays truncated address (copy-to-clipboard), balance formatted as $ (raw/1,000,000), connection status badge, refresh button. Loading skeleton + error states.
8. **market-maker/MMFaucetCard.tsx** (new) — Preset amounts ($10, $50, $100, $500), custom input (multiples of $10), divides by 10 for count. Shows success/warning/error states. Calls onFunded callback for balance refresh.
9. **market-maker/index.ts** (new) — Barrel export
10. **MMBalanceCard.test.tsx** (new) — 5 tests (loading, display, refresh, error, disconnected)
11. **MMFaucetCard.test.tsx** (new) — 9 tests (presets, selection, custom input, submit, loading, success, partial failure, error, onFunded callback)

### Test Results
- **Hub:** 199 passed (was 193, +6 new: 2 mm routes + 4 faucet batch)
- **Frontend:** 104 passed (was 84, +20 new: 3 api + 1 header + 5 balance + 9 faucet + 2 unused)
- **Dashboard:** 26 passed (unchanged)
- **Total:** 329 passing tests

### Architecture Notes
- MMBalanceCard uses `refreshKey` prop to trigger re-fetch after faucet funding
- Balance formatted by dividing raw string by 1,000,000 (ytest.usdc uses 6 decimals)
- Faucet batch: count = selectedAmount / 10 (each faucet request = $10 ytest.usdc)
- Partial failure returns `{ success: true, funded: N, requested: count, error: string }` — no 500 if at least one succeeded

---

## Fix: GET /api/mm/info crash when ClearnodeClient disconnected
Date: 2026-02-05

### Problem
`GET /api/mm/info` threw 500 with `"ClearnodeClient is not connected"` because `getBalance()` calls `assertConnected()` internally. When the hub starts without Clearnode credentials or the WebSocket hasn't connected, the endpoint crashed.

### Fix
- Check `isConnected()` before calling `getBalance()`. When disconnected, return `balance: "0"` instead of crashing.
- Moved `isConnected` check before `getBalance` call so it gates the balance fetch.

### Files Changed
- `packages/hub/src/api/mm.routes.ts` — Reordered: get address → check isConnected → conditionally get balance
- `packages/hub/src/api/mm.routes.test.ts` — Added test: disconnected case returns 200 with `{ address: "0xMM", balance: "0", isConnected: false }`

### Test Results
- **Hub:** 200 passed (was 199, +1 new disconnected test)
- **Total:** 330 passing tests

---

## Fix: Connect ClearnodeClient on server startup
Date: 2026-02-05

### Problem
`clearnodeClient.connect()` was never called in `server.ts`. The client was constructed but the WebSocket + EIP-712 auth handshake was never initiated, meaning `isConnected()` was always `false` in production and all WebSocket-dependent operations would fail.

### Fix
1. **server.ts** — Added `await clearnodeClient.connect()` after `app.listen()` in a try/catch. On success logs `clearnodeConnected`, on failure logs error + `clearnodeDisconnected`. Server stays up either way (degraded mode — faucet HTTP still works, `mm/info` returns `balance: "0"`).
2. **logger.ts** — Added `clearnodeConnected(address)` and `clearnodeDisconnected()` methods with ANSI formatting.
3. **logger.test.ts** — Added both methods to existing test blocks (callable + no stdout in test env).
4. **context.ts** — Verified: mock already had `connect` and `disconnect` — no changes needed.

### Test Results
- **Hub:** 200 passed (unchanged count, existing tests still pass)
- **Total:** 330 passing tests

---

## Frontend ClearnodeProvider Implementation
Date: 2026-02-05

### What was done:
Implemented a `ClearnodeProvider` that authenticates the bettor's wallet with the Yellow Network Clearnode on wallet connect, obtains a session key, and exposes the signer/WS for future Clearnode operations.

#### New files:
1. **`lib/clearnode/types.ts`** — `ClearnodeStatus`, `ClearnodeContextValue`, `AuthResult` types
2. **`lib/clearnode/rpc.ts`** — Browser-compatible `sendAndWaitBrowser()` and `openClearnodeWs()` (ported from yellow-quickstart)
3. **`lib/clearnode/auth.ts`** — Browser-compatible 3-step EIP-712 auth (`authenticateBrowser()`) mirroring hub's auth.ts
4. **`lib/clearnode/index.ts`** — Barrel re-export
5. **`providers/ClearnodeProvider.tsx`** — React context provider with auto-auth on wallet connect, balance fetch, reconnect/disconnect
6. **`hooks/useClearnode.ts`** — Convenience hook re-export
7. **`test/mocks/nitroliteModule.ts`** — Jest mock for `@erc7824/nitrolite` SDK

#### Test files:
- `lib/clearnode/rpc.test.ts` — 8 tests (sendAndWaitBrowser: resolve, ignore non-matching, RPC error, timeout, cleanup, unparseable; openClearnodeWs: resolve on open, reject on error)
- `lib/clearnode/auth.test.ts` — 6 tests (full 3-step flow, no account, verify fail, propagate errors, custom config, default config)
- `providers/ClearnodeProvider.test.tsx` — 10 tests (disconnected, auto-auth, balance fetch, WS fail, auth fail, ws ref, disconnect cleanup, reconnect, unmount cleanup, balance fetch fail)

#### Modified files:
- **`package.json`** — Added `@erc7824/nitrolite@^0.5.3` dependency
- **`jest.config.js`** — Added `@erc7824/nitrolite` and `viem/chains` module name mappers
- **`lib/config.ts`** — Added `CLEARNODE_URL` export
- **`test/mocks/wagmiModule.ts`** — Added `useWalletClient` mock + `__setMockWalletClient()` test utility
- **`test/mocks/viemModule.ts`** — Updated `createWalletClient` to accept options including account
- **`app/LayoutInner.tsx`** — Inserted `ClearnodeProvider` between `WagmiProvider` and `WebSocketProvider`
- **`providers/index.ts`** — Added ClearnodeProvider + useClearnode exports
- **`.env.local.example`** — Added `NEXT_PUBLIC_CLEARNODE_URL`

### Provider hierarchy:
```
WagmiProvider              (wallet: MetaMask or private-key)
  ClearnodeProvider        (Clearnode WS auth, session key, balance)
    WebSocketProvider      (Hub WS: market updates)
      MarketProvider       (market state)
```

### Context interface:
```typescript
interface ClearnodeContextValue {
  status: 'disconnected' | 'connecting' | 'authenticating' | 'connected' | 'error';
  error: string | null;
  isSessionValid: boolean;
  signer: MessageSigner | null;
  ws: WebSocket | null;
  balance: string | null;
  refreshBalance: () => Promise<void>;
  reconnect: () => Promise<void>;
  disconnect: () => void;
}
```

### Auth flow:
- Private-key mode: auto-creates WalletClient from env var, signs EIP-712 automatically
- MetaMask mode: waits for wagmi's useWalletClient to be available, then delegates signing to MetaMask
- Both modes: opens WS → 3-step EIP-712 auth → stores session signer → fetches balance
- Session expiry tracked via `expiresAt` + `isSessionValid` computed property

### Test Results
- **Frontend:** 128 passed (was 104, +24 new: 8 rpc + 6 auth + 10 provider)
- **Total:** 354 passing tests

---

## User Account Page Implementation
Date: 2026-02-05

### What was done:
Implemented the `/account` page with 3 cards: Session management, Faucet funding, and Balance display.

#### Hub Changes
1. **types.ts** — Changed `FaucetRequest` from `{ address, amount }` to `{ address, count? }` (count-based like MM faucet)
2. **faucet.routes.ts** — Rewrote `POST /api/faucet/user` to call `requestFaucet(address)` from clearnode/faucet.ts in a loop. Accepts `{ address, count? }` (default 1, max 50). Returns `{ success, funded }` or partial failure with `{ success, funded, requested, error }`.
3. **logger.ts** — Updated `faucetUser()` to match count-based pattern: `faucetUser(address, count?, error?)`
4. **faucet.routes.test.ts** — Rewrote user faucet tests (7 tests: success, missing address, count=3, default count, count>50, partial failure, total failure). Mock of `requestFaucet` module added.
5. **logger.test.ts** — Updated faucetUser test calls to match new signature.

#### Frontend: ClearnodeProvider Updates
1. **lib/clearnode/types.ts** — Added `expiresAt`, `allowanceAmount`, `setAllowanceAmount` to `ClearnodeContextValue`
2. **providers/ClearnodeProvider.tsx** — Added `allowanceAmount` state (default 1000), `setAllowanceAmount` setter, exposed `expiresAt` in context. Passes custom allowance to `authenticateBrowser()`.
3. **providers/ClearnodeProvider.test.tsx** — Added 4 tests: expiresAt exposed, allowanceAmount default, setAllowanceAmount updates, allowance passed to auth

#### Frontend: API + Types
1. **lib/types.ts** — Added `UserFaucetResponse` interface
2. **lib/api.ts** — Added `requestUserFaucet(address, count?)` function
3. **lib/api.test.ts** — Added 2 tests for requestUserFaucet

#### Frontend: Account Components (new)
1. **components/account/SessionCard.tsx** — Session status badge (Active/Expired/Connecting/Error/Not Authenticated), expiry time display, allowance input, re-authenticate button
2. **components/account/AccountBalanceCard.tsx** — Balance display ($X.XX from raw/1M), refresh button, not-connected state
3. **components/account/AccountFaucetCard.tsx** — Preset amounts ($10/$50/$100/$500), custom input (multiples of $10), calls requestUserFaucet + refreshBalance, success/warning/error states
4. **components/account/index.ts** — Barrel export

#### Frontend: Page + Navigation
1. **app/account/page.tsx** — 3-card layout: SessionCard (full width), FaucetCard (2/3), BalanceCard (1/3). Uses refreshKey pattern.
2. **components/Header.tsx** — Added "Account" nav link with data-testid="nav-account"
3. **components/Header.test.tsx** — Updated to verify Account link presence

#### Test Files (new)
- `SessionCard.test.tsx` — 10 tests (status badges, expiry, reconnect, disabled state, allowance input)
- `AccountBalanceCard.test.tsx` — 5 tests (not-connected, balance display, null balance, refresh, large balance)
- `AccountFaucetCard.test.tsx` — 9 tests (presets, selection, custom input, submit, loading, success, partial failure, error, onFunded + refreshBalance callback)

### Test Results
- **Hub:** 204 passed (was 200, +4 new user faucet route tests)
- **Frontend:** 158 passed (was 128, +30 new: 4 provider + 2 api + 10 session + 5 balance + 9 faucet)
- **Dashboard:** 26 passed (unchanged)
- **Total:** 388 passing tests

### Architecture Notes
- User faucet routes through hub (avoids CORS issues with sandbox faucet direct call)
- Allowance is stored in ClearnodeProvider state; changing it requires re-authentication
- Session expiry and validity exposed in context for UI display
- AccountFaucetCard calls both onFunded callback (refreshKey) and refreshBalance (Clearnode balance)
- Same refreshKey pattern as MM page for faucet → balance refresh coordination

---

## Dashboard Upgrade: Fullscreen Interactive TUI
Date: 2026-02-05

### What was done:
Upgraded the `packages/dashboard/` terminal app from a simple read-only view to a fullscreen, interactive TUI with alternate screen buffer, dynamic sizing, panel navigation, scrollable panels, vim-style command bar, and visual price bars.

### New files:
1. **`hooks/useTerminalSize.ts`** — Hook returning `{ columns, rows }` from `process.stdout`, updates on resize, fallback 80x24
2. **`components/PriceBar.tsx`** — ASCII progress bar (`█░`) for BALL/STRIKE odds visualization
3. **`components/CommandBar.tsx`** — Footer component: keybinding hints (normal), command input (command mode), status messages
4. **`components/HelpOverlay.tsx`** — Keybinding reference screen (press `?` to toggle)

### Modified files:
1. **`hooks/useWebSocket.ts`** — Added `reconnect()` to `UseWebSocketResult` interface and return value
2. **`utils/formatters.ts`** — Added `renderPriceBar(probability, width)` pure function
3. **`index.tsx`** — Alternate screen buffer enter/exit (`\x1b[?1049h/l`), cursor hide/show, signal handlers (SIGINT, SIGTERM, uncaughtException), passes `hubUrl` prop to App
4. **`App.tsx`** — Major rewrite:
   - Fullscreen layout with `height={rows}` from useTerminalSize
   - Panel navigation (Tab to switch, j/k to scroll, g/G for top/bottom)
   - Command mode (`:clear`, `:reset`, `:reconnect`, `:quit`)
   - Help mode (press `?`)
   - Auto-scroll event log to bottom (disabled when user manually scrolls up, re-enabled on `G`)
   - Dynamic visible count calculation based on terminal rows
   - Price bar width derived from `columns / 2 - 6`
5. **`components/MarketPanel.tsx`** — Replaced plain text odds with PriceBar components, accepts `barWidth` prop
6. **`components/PositionsPanel.tsx`** — Scrollable with `scrollOffset`/`visibleCount`/`isActive` props, cyan border when active, scroll indicator
7. **`components/EventLog.tsx`** — Same scrollable pattern as PositionsPanel, chronological order (oldest first)
8. **`components/SystemInfo.tsx`** — Added `flexShrink={0}` for layout stability
9. **`components/index.ts`** — Added PriceBar, CommandBar, HelpOverlay exports
10. **`hooks/index.ts`** — Added useTerminalSize export
11. **`README.md`** — Updated with new layout diagram, controls tables, commands, architecture notes

### Test Results:
- **Dashboard:** 33 passed (was 26, +7 new renderPriceBar tests)
- TypeScript: zero errors (`tsc --noEmit` clean)

### Controls:
- **Tab** — Switch active panel (Positions ↔ Event Log)
- **j/↓, k/↑** — Scroll active panel
- **g/G** — Top/bottom of active panel
- **?** — Toggle help overlay
- **:** — Enter command mode
- **q** — Quit
- **:clear/:c** — Clear event log
- **:reset/:r** — POST /api/admin/reset
- **:reconnect** — Reconnect WebSocket
- **:quit/:q** — Quit

### Architecture Notes:
- Alternate screen buffer ensures terminal history is preserved
- `useTerminalSize` listens to `process.stdout.on('resize')` for dynamic layout
- Event log auto-scrolls to bottom unless user manually scrolled up; pressing `G` re-enables auto-scroll
- `reconnect()` in useWebSocket closes current WS, clears timeout, resets attempts, and reconnects
- `renderPriceBar()` is a pure function for testability — PriceBar component just renders its output
- No new npm dependencies required

---

## Clearnode Client Methods: Hub + Frontend
Date: 2026-02-05

### What was done:
Added `createAppSession`, `getAppSessions` to the Hub ClearnodeClient, and a full set of pure RPC method functions for the Frontend. Integrated all methods into the ClearnodeProvider context.

### Hub Changes
1. **types.ts** — Added `CreateAppSessionParams`, `CreateAppSessionResult`, `AppSessionInfo` interfaces
2. **client.ts** — Added `createAppSession()` and `getAppSessions()` methods with new nitrolite SDK imports (`createAppSessionMessage`, `parseCreateAppSessionResponse`, `createGetAppSessionsMessage`, `parseGetAppSessionsResponse`, `RPCProtocolVersion`, `RPCChannelStatus`)
3. **client.test.ts** — Added 8 tests in 2 new describe blocks: createAppSession (4 tests), getAppSessions (4 tests)
4. **context.ts** — Added `createAppSession` and `getAppSessions` to mockClearnode in `createTestContext()`

### Frontend Changes
1. **lib/clearnode/methods.ts** (new) — 6 pure async RPC functions: `createAppSession`, `closeAppSession`, `submitAppState`, `transfer`, `getAppSessions`, `getConfig`. Each takes `(ws, signer, ...)` — testable without React.
2. **lib/clearnode/methods.test.ts** (new) — 17 tests covering all 6 methods (correct SDK calls, return values, throws when not connected)
3. **test/mocks/nitroliteModule.ts** — Added 14 new mock exports for all app session, state, transfer, config SDK functions + RPCAppStateIntent and RPCProtocolVersion enums
4. **lib/clearnode/index.ts** — Added `export * from './methods'`
5. **lib/clearnode/types.ts** — Extended `ClearnodeContextValue` with 6 new method signatures
6. **providers/ClearnodeProvider.tsx** — Added 6 useCallback wrappers that capture wsRef/signer/address, updated default context with error-throwing stubs
7. **providers/ClearnodeProvider.test.tsx** — Added 6 tests verifying each method delegates correctly when connected

### Also fixed:
- Removed unused `waitFor` import from `SessionCard.test.tsx` (pre-existing lint issue)

### Test Results
- **Hub:** 212 passed (was 204, +8 new clearnode client tests)
- **Frontend:** 181 passed (was 158, +17 methods + 6 provider)
- **Frontend build:** ✅ succeeds
- **Total:** 393+ passing tests

### Architecture Notes
- Frontend methods are pure functions (not hooks/components) for easier testing
- `getConfig` uses V2 variant (synchronous, no signer needed)
- `createAppSession` defaults to `pulse-play` application, NitroRPC/0.4 protocol, weights [0, 100] quorum 100 (bettor has 0 weight, MM has 100 = full control)
- All methods use `assertReady()` guard that checks WS readyState and signer presence
- Provider uses `useCallback` with dependency on `signer` and `address` for React memoization

---

## Bug Fixes: Account Page Issues
Date: 2026-02-05

### Bug 1: Allowance input triggers re-authentication on every keystroke
**Root cause:** `allowanceAmount` was in the dependency array of `authenticate` (useCallback), which was in the dependency array of the auto-connect `useEffect`. Changing the input → new state → new callback ref → useEffect re-fires → calls `authenticate()`.
**Fix:** Added `allowanceAmountRef` (useRef) synced via a useEffect. `authenticate` now reads `allowanceAmountRef.current` instead of `allowanceAmount`, removing it from the callback dependency array.
**Files:** `ClearnodeProvider.tsx`, `ClearnodeProvider.test.tsx` (+1 test: changing allowance does not trigger re-auth)

### Bug 2: Fund Account shows `{"error":"amount must be a positive number"}`
**Root cause:** Stale `dist/` build had old faucet validation code. Source TypeScript was already correct.
**Fix:** Rebuilt with `pnpm --filter @pulse-play/hub build`. No code changes needed.

### Bug 3: Balance card not visible on Bettor page
**Root cause:** `AccountBalanceCard` only existed on `/account` page, not the bettor page.
**Fix:** Imported `AccountBalanceCard` into `app/page.tsx` and placed it above `PositionList` in the right sidebar.

### Test Results
- **Hub:** 212 passed (unchanged)
- **Frontend:** 182 passed (was 181, +1 new re-auth guard test)
- **Dashboard:** 33 passed (unchanged)
- **Total:** 427 passing tests

---

## Fix: qBall/qStrike not updating in dashboard MarketPanel
Date: 2026-02-05

### Root Cause
When a bet was placed, the hub broadcast `ODDS_UPDATE` containing only `priceBall`, `priceStrike`, and `marketId`. The updated `qBall`/`qStrike` values were not included. The dashboard's `ODDS_UPDATE` handler updated prices but never touched `state.market.qBall/qStrike`, so MarketPanel showed stale values (only initialized on `STATE_SYNC`). Same gap existed in the oracle market-open broadcast.

### Fix
Added `qBall` and `qStrike` fields to the `WsOddsUpdate` type and all broadcast sites.

### Files Changed

**Hub:**
- `api/types.ts` — Added `qBall`, `qStrike` to `WsOddsUpdate` interface
- `api/bet.routes.ts` — Include `qBall`, `qStrike` in ODDS_UPDATE broadcast after bet
- `api/oracle.routes.ts` — Include `qBall: market.qBall`, `qStrike: market.qStrike` in market-open ODDS_UPDATE broadcast
- `api/bet.routes.test.ts` — Added `qBall: expect.any(Number)`, `qStrike: expect.any(Number)` to ODDS_UPDATE assertion
- `api/oracle.routes.test.ts` — Added `qBall: 0`, `qStrike: 0` to market-open ODDS_UPDATE assertion

**Dashboard:**
- `types.ts` — Added `qBall`, `qStrike` to `WsOddsUpdate`
- `App.tsx` — ODDS_UPDATE handler now writes `qBall`/`qStrike` into `state.market`
- `utils/formatters.test.ts` — Added `qBall`, `qStrike` to ODDS_UPDATE test message literal

**Frontend:**
- `lib/types.ts` — Added `qBall`, `qStrike` to `WsOddsUpdate`
- `providers/MarketProvider.test.tsx` — Added `qBall`, `qStrike` to ODDS_UPDATE test message literal
- `providers/WebSocketProvider.test.tsx` — Added `qBall`, `qStrike` to ODDS_UPDATE test message literal

### Test Results
- **Hub:** 212 passed (unchanged count)
- **Frontend:** 182 passed (unchanged count)
- **Dashboard:** 33 passed (unchanged count)
- **Total:** 427 passing tests

---

## Fix: Dashboard MarketPanel crash on bet — `qBall.toFixed` undefined
Date: 2026-02-05

### Root Cause
The hub ran from compiled `dist/` (old build) while dashboard ran from TypeScript source (new code). The ODDS_UPDATE handler in `App.tsx` wrote `msg.qBall`/`msg.qStrike` into state unconditionally, but the stale `dist/` build didn't include those fields. Result: `undefined` overwrote valid values from STATE_SYNC, and `MarketPanel.tsx:57` crashed calling `.toFixed(2)` on `undefined`.

### Fixes
1. **Rebuilt hub** (`pnpm --filter @pulse-play/hub build`) — compiled `dist/` now includes `qBall`/`qStrike` in ODDS_UPDATE
2. **`dashboard/src/App.tsx`** — ODDS_UPDATE handler now guards setState with `msg.qBall !== undefined && msg.qStrike !== undefined`
3. **`dashboard/src/components/MarketPanel.tsx`** — Added `?? 0` fallback: `(market.qBall ?? 0).toFixed(2)` as defensive safety net

### Test Results
- **Dashboard:** 33 passed (unchanged)
- **Total:** 427 passing tests

---

## Fix: ClearnodeClient Drops Connection — Lazy Connect + Auto-Heal
Date: 2026-02-05

### Root Cause
The `ClearnodeClient` opened a WebSocket at server startup (`server.ts`) and never handled disconnection. When the Clearnode server dropped the connection (idle timeout, server restart, etc.), `isConnected()` returned `false` permanently — no recovery, no reconnect.

### Solution: Lazy Connect with Reuse
Replaced the upfront `connect()` at startup with an internal `ensureConnected()` before every RPC call. If the connection is live, reuse it (fast path). If it's dead or never opened, connect transparently. Deduplicates concurrent connect attempts via a shared promise.

### Files Changed

**`packages/hub/src/modules/clearnode/client.ts`**
- Added `private connectPromise: Promise<void> | null = null` field
- Added `private async ensureConnected()` method — checks `isConnected()` first, deduplicates via shared promise
- Replaced `this.assertConnected()` with `await this.ensureConnected()` in all 6 RPC methods (getBalance, submitAppState, closeSession, transfer, createAppSession, getAppSessions)
- Removed `private assertConnected()` method

**`packages/hub/src/server.ts`**
- Removed the post-startup `connect()` try/catch block (lines 43-50). Server starts instantly, client connects lazily on first API call.

**`packages/hub/src/logger.ts`**
- Added `clearnodeAutoConnect()` method

**`packages/hub/src/logger.test.ts`**
- Added `clearnodeAutoConnect` to both test blocks

**`packages/hub/src/modules/clearnode/client.test.ts`**
- Removed 6 "throws when not connected" tests (no longer applicable — methods auto-connect)
- Added 5 new tests in `describe("lazy connection")`:
  1. `auto-connects on first RPC call when not connected`
  2. `reuses existing connection on subsequent calls`
  3. `reconnects transparently when connection has dropped`
  4. `deduplicates concurrent connect attempts`
  5. `propagates connect failure to caller`

### Test Results
- **Hub:** 211 passed (was 212: -6 removed "not connected" tests, +5 new lazy connection tests)
- **Hub build:** ✅ clean (zero TypeScript errors)

### Behavioral Changes
- `connect()` / `disconnect()` / `isConnected()` remain public with same signatures
- Server starts without Clearnode dependency (faster startup)
- Connection self-heals on next RPC call after drop
- `GET /api/mm/info` calls `getBalance()` which now auto-connects, so the endpoint should almost always return `isConnected: true`
- No keepalive, no ping/pong, no reconnect timers needed

---

## Wire App Sessions into Betting Flow — Complete
Date: 2026-02-05

### Summary
Wired real Clearnode app sessions into three betting paths: bet placement (frontend), bet rejection (hub), and market resolution (hub). Previously, the frontend used a fake `appSessionId: session-${Date.now()}` and the hub never interacted with Clearnode during the bet lifecycle. Now:

1. **Frontend creates real app sessions** before notifying the hub via `useBet` hook
2. **Hub closes app sessions** when rejecting bets (returns user funds)
3. **Hub settles positions via Clearnode** at resolution (reallocates losers, pays winners)

### Steps Completed
1. **Unit conversion utility** — `toMicroUnits`/`fromMicroUnits` in both hub and frontend (Clearnode uses microunits: 1 USDC = 1,000,000)
2. **`appSessionVersion` field** — Added to Position, BetRequest, and all WS message types across hub, frontend, and dashboard
3. **`MM_ADDRESS` config** — Frontend reads from `NEXT_PUBLIC_MM_ADDRESS` env var
4. **`useBet` hook rewrite** — Creates real Clearnode app session → notifies hub with real session ID/version. Step tracking: `idle → creating-session → notifying-hub`
5. **Hub bet rejection** — Closes app session on market-state rejection to return user funds
6. **Hub resolution settlement** — Losers: `submitAppState` (reallocate to MM) + `closeSession`. Winners: `closeSession` (return costPaid) + `transfer` (profit). Losers processed first (MM needs funds).

### Files Created
- `packages/hub/src/utils/units.ts` — toMicroUnits, fromMicroUnits, MICRO, ASSET constants
- `packages/hub/src/utils/units.test.ts` — 8 tests
- `packages/frontend/src/lib/units.ts` — Same utility for frontend

### Files Modified
- `packages/hub/src/modules/position/types.ts` — Added `appSessionVersion: number`
- `packages/hub/src/api/types.ts` — Added `appSessionVersion` to BetRequest, WsPositionAdded, WsStateSync, PositionsResponse
- `packages/hub/src/api/bet.routes.ts` — Records appSessionVersion, closes session on rejection
- `packages/hub/src/api/oracle.routes.ts` — Full Clearnode settlement loop at resolution
- `packages/hub/src/api/positions.routes.ts` — Includes appSessionVersion in response
- `packages/hub/src/api/mm.routes.ts` — Fixed to check `isConnected()` and include in response
- `packages/hub/src/logger.ts` — 4 new log methods
- `packages/frontend/src/hooks/useBet.ts` — Rewritten for real app sessions
- `packages/frontend/src/components/bettor/BetForm.tsx` — Removed fake session ID, step-based loading
- `packages/frontend/src/lib/config.ts` — Added MM_ADDRESS
- `packages/frontend/src/lib/types.ts` — Added appSessionVersion
- `packages/dashboard/src/types.ts` — Added appSessionVersion
- All relevant test files updated across hub, frontend, dashboard

### Key Technical Details
- `AppSessionAllocation` uses `participant` field (NOT `destination`). `TransferParams` uses `destination`.
- `appSessionId` must be cast to `0x${string}` (Hex type) for Clearnode API calls
- Resolution processes losers before winners (MM needs loser funds to pay winner profit)
- Each position settlement wrapped in individual try/catch (continues on failure)
- `profit = payout (shares) - costPaid` — transfer only when profit > 0
- `jest.resetModules()` breaks React hooks (dual React instance) — used `globalThis` getter pattern for mutable config in tests

### Test Results
- **Hub:** 18 suites, 230 passed (6 skipped — pre-existing)
- **Frontend:** 24 suites, 185 passed
- **Dashboard:** 1 suite, 33 passed
- **Hub build:** ✅ clean
- **Frontend build:** ✅ clean

---

## Dashboard App Session Visibility
Date: 2026-02-05

### What was done:
Added session lifecycle tracking and visibility to the developer dashboard, giving developers a window into Yellow Network activity (Clearnode app sessions) alongside betting positions.

### Hub Changes:
1. **Position type** — Added `SessionStatus = 'open' | 'settling' | 'settled'` and `sessionStatus: SessionStatus` field to Position
2. **PositionTracker** — Added `updateSessionStatus(appSessionId, status)` method
3. **API types** — Added `WsSessionSettled` message type, `sessionCounts` to `AdminStateResponse`, `sessionStatus` to position shapes
4. **bet.routes.ts** — Sets `sessionStatus: 'open'` when recording positions
5. **oracle.routes.ts** — Calls `updateSessionStatus('settled')` + broadcasts `SESSION_SETTLED` after each loser/winner settlement (inside try/catch, only on success)
6. **admin.routes.ts** — Computes `sessionCounts: { open, settled }` from positions for admin state response
7. **app.ts** — STATE_SYNC includes `sessionCounts` for initial client sync

### Dashboard Changes:
1. **formatters.ts** — Added `getSessionStatusColor()` (open→green, settling→yellow, settled→blue), `SESSION_SETTLED` case in `formatWsMessage()`
2. **App.tsx** — Added `SESSION_SETTLED` handler (updates position status + decrements open/increments settled counts), `POSITION_ADDED` increments open count, adjusted `positionsVisibleCount` for 2-line layout
3. **PositionsPanel.tsx** — Two-line layout per position: Line 1 = bet info (address, outcome, shares, cost), Line 2 = session info (appSessionId, version, status with color)
4. **SystemInfo.tsx** — Added sessions row showing `open/settled` counts with green/blue color coding

### Frontend Changes:
- Mirrored type updates: `SessionStatus`, `sessionStatus` on Position, `WsSessionSettled`, `sessionCounts` on `AdminStateResponse`

### Files Modified:
- `hub/src/modules/position/types.ts` — SessionStatus + sessionStatus field
- `hub/src/modules/position/tracker.ts` — updateSessionStatus()
- `hub/src/modules/position/tracker.test.ts` — 3 new tests
- `hub/src/api/types.ts` — WsSessionSettled, sessionCounts, sessionStatus in shapes
- `hub/src/api/bet.routes.ts` — sessionStatus: 'open'
- `hub/src/api/oracle.routes.ts` — SESSION_SETTLED broadcast + updateSessionStatus
- `hub/src/api/admin.routes.ts` — sessionCounts computation
- `hub/src/api/positions.routes.ts` — sessionStatus in response mapping
- `hub/src/app.ts` — sessionCounts in STATE_SYNC
- `dashboard/src/types.ts` — Mirrored hub types
- `dashboard/src/utils/formatters.ts` — getSessionStatusColor, SESSION_SETTLED formatting
- `dashboard/src/utils/formatters.test.ts` — 6 new tests (4 sessionStatusColor + 1 SESSION_SETTLED + updated fixtures)
- `dashboard/src/App.tsx` — SESSION_SETTLED handler, layout calc, session count tracking
- `dashboard/src/components/PositionsPanel.tsx` — Two-line layout with session info
- `dashboard/src/components/SystemInfo.tsx` — Sessions row
- `frontend/src/lib/types.ts` — Type parity
- All hub test files updated with `sessionStatus: 'open'` in Position objects

### Test Results
- **Hub:** 18 suites, 233 passed (6 skipped — pre-existing)
- **Frontend:** 24 suites, 185 passed
- **Dashboard:** 1 suite, 38 passed
- **Hub build:** ✅ clean
- **Dashboard build:** ✅ clean
- **Frontend build:** ✅ clean

---

## Simulator Package Implementation
Date: 2026-02-05

### What was done:
Implemented `packages/simulator/` — a standalone Ink (React for terminal) app that generates wallets, funds them, controls the oracle, runs automated betting simulations, and displays everything in a fullscreen terminal UI for demo purposes.

### Package Structure:
```
packages/simulator/
├── package.json, tsconfig.json, jest.config.js
├── README.md, AGENTS.md
├── src/
│   ├── index.tsx                    — Entry point (CLI args, alt-screen, signals)
│   ├── App.tsx                      — Main Ink app (state, commands, layout)
│   ├── types.ts                     — Shared types (mirrors hub WsMessage + sim types)
│   ├── core/
│   │   ├── wallet-manager.ts        — Wallet generation + tracking (21 tests)
│   │   ├── hub-client.ts            — Hub REST client (15 tests)
│   │   ├── clearnode-pool.ts        — Per-wallet lazy Clearnode WS (14 tests)
│   │   ├── clearnode/auth.ts        — 3-step EIP-712 auth (adapted from hub)
│   │   ├── clearnode/rpc.ts         — sendAndWait helper (copied from hub)
│   │   └── simulation-engine.ts     — Bet orchestration (16 tests)
│   ├── hooks/
│   │   ├── useWebSocket.ts          — Adapted from dashboard
│   │   └── useTerminalSize.ts       — Copied from dashboard
│   ├── components/
│   │   ├── Header.tsx, WalletTable.tsx, MarketPanel.tsx, PriceBar.tsx
│   │   ├── EventLog.tsx, CommandBar.tsx, ResultsPanel.tsx, HelpOverlay.tsx
│   │   └── index.ts
│   ├── utils/
│   │   ├── formatters.ts            — Formatting helpers (36 tests)
│   │   └── units.ts                 — toMicroUnits/fromMicroUnits
│   └── test/mocks/
│       └── nitroliteModule.ts       — Jest mock for @erc7824/nitrolite
```

### Core Modules:
1. **WalletManager** — Generates private keys via viem, 1-based indexing, balance/funded tracking, profile assignment with ballBias
2. **HubClient** — REST wrapper for all hub endpoints: bet, faucet (user/mm), oracle (game-state/open/close/resolve), admin (state/positions/reset), mm/info
3. **ClearnodePool** — Per-wallet lazy Clearnode connections with EIP-712 auth, connection dedup via shared promise, createAppSession for betting
4. **SimulationEngine** — Staggered timer-based bet orchestration, resilient error handling, start/stop lifecycle, configurable SimConfig

### App Commands:
`:wallets <n>`, `:fund`, `:fund-mm [n]`, `:open`, `:close`, `:resolve ball|strike`,
`:sim start|stop|config`, `:status`, `:reset`, `:clear`, `:reconnect`, `:quit`

### Key Technical Details:
- Uses same 3-step EIP-712 auth flow as hub ClearnodeClient
- ClearnodePool deduplicates concurrent connect attempts via shared promise (same pattern as hub client.ts:238-245)
- SimulationEngine is resilient: errors don't stop the simulation, they emit events and schedule next bet
- WS message handling mirrors dashboard App.tsx patterns (STATE_SYNC, ODDS_UPDATE, MARKET_STATUS, etc.)
- Results computed on MARKET_STATUS RESOLVED by fetching positions and matching to simulator wallets

### Test Results:
- **Simulator:** 5 suites, 102 passed
  - wallet-manager: 21 tests
  - hub-client: 15 tests
  - clearnode-pool: 14 tests
  - simulation-engine: 16 tests
  - formatters: 36 tests
- **TypeScript:** ✅ clean (tsc --noEmit passes)

### Branch: feature/simulator

---

## Dashboard PositionsPanel → State Channels Table Redesign
Date: 2026-02-05

### What was done:
Redesigned the dashboard PositionsPanel from a plain two-line layout into a professional, session-first tabular layout branded as "⚡ STATE CHANNELS" for hackathon demo impact.

### Design Changes:
1. **Title**: `⚡ STATE CHANNELS (N)` in yellow+bold — Yellow Network branding
2. **Column headers**: SESSION | BETTOR | BET | ALLOC | v | STATUS — with gray bold text
3. **Separator line**: `─` repeated, gray dimColor
4. **Session ID first**: Yellow color, first column — state channels are the star
5. **Status badges**: Unicode indicators — `● OPEN` (green), `◌ SETTLING` (yellow), `◉ SETTLED` (blue)
6. **BET column**: Abbreviated `BALL`/`STRK` via `formatOutcomeShort()`
7. **ALLOC column**: `costPaid` (value locked in channel) — state channel terminology
8. **Version**: Compact `v1`/`v2` showing state channel updates
9. **Single-line per position**: Nearly doubles visible density vs. old two-line layout
10. **Empty state**: "Awaiting state channel activity..." instead of "No positions"
11. **Shares column dropped**: LMSR detail that distracts from state channel narrative

### Files Modified:
- `dashboard/src/utils/formatters.ts` — Added `formatStatusBadge()`, `formatOutcomeShort()`, `formatVersion()`
- `dashboard/src/utils/formatters.test.ts` — Added 9 tests (4 badge + 2 outcome + 3 version)
- `dashboard/src/components/PositionsPanel.tsx` — Full rewrite with tabular layout
- `dashboard/src/App.tsx` — Adjusted `positionsVisibleCount` from `Math.floor((rows-19)/2)` to `rows-21`

### Test Results:
- **Dashboard:** 1 suite, 47 passed
- **Dashboard build:** ✅ clean

---

## Simulator Bug Fixes: Balances, Layout, Speed
Date: 2026-02-06

### Bugs Fixed

**Bug 1: Balances don't update in real time**
- Root cause: `App.tsx` hardcoded `walletManager.updateBalance(w.index, '50000000')` after funding and never updated again
- Fix: Added `getBalance(address)` to `ClearnodePool` that fetches actual Clearnode ledger balance via `createGetLedgerBalancesMessage`/`parseGetLedgerBalancesResponse`
- Used in 3 places: after funding (`:fund`), after each bet (SimulationEngine), on `:status` command
- All balance fetches have fallback/silent-catch for resilience

**Bug 2: Event log cramped in 40% right column**
- Root cause: Layout was 60/40 side-by-side with EventLog behind MarketPanel+ResultsPanel in narrow right column
- Fix: Switched to top/bottom layout — WalletTable(55%)+MarketPanel(45%) side-by-side on top (~50% height), EventLog full-width on bottom (~50% height)

**Bug 3: Funding is slow (sequential)**
- Root cause: `:fund` command awaited each wallet fund sequentially
- Fix: Batched with `Promise.allSettled()`, 5 wallets per batch. UI updates after each batch. ~4x faster for 20 wallets.

### Files Changed
- `simulator/src/core/clearnode-pool.ts` — Added `getBalance()` method + nitrolite imports
- `simulator/src/core/clearnode-pool.test.ts` — +2 tests (getBalance success, asset not found)
- `simulator/src/core/simulation-engine.ts` — Balance refresh after successful bet
- `simulator/src/core/simulation-engine.test.ts` — +2 tests (balance refresh, graceful failure)
- `simulator/src/App.tsx` — Layout restructure + parallel funding + real balance fetch + `:status` balance refresh

### Test Results
- **Simulator:** 5 suites, 106 passed (was 102, +4 new)
- **TypeScript:** ✅ clean (tsc --noEmit passes)

---

## Dashboard Polish + Loser Session Status Bug Fix
Date: 2026-02-06

### Bug Fixed: Losers stay "open" after market resolution
**Root cause:** In `oracle.routes.ts`, `updateSessionStatus('settled')` and `SESSION_SETTLED` broadcast were INSIDE the try/catch block for Clearnode calls. If `submitAppState()` or `closeSession()` threw, the catch fired and the status update + broadcast were skipped. Meanwhile `BET_RESULT` was sent outside the try/catch, so the user saw "you lost" but the session stayed "open" on the dashboard.

**Fix:** Moved `updateSessionStatus`, `SESSION_SETTLED` broadcast, and `BET_RESULT` send OUTSIDE the try/catch for both losers AND winners. Now they always execute regardless of Clearnode call success. Updated the "continues resolution" test to verify SESSION_SETTLED is broadcast even when Clearnode fails.

### Dashboard UI Fixes
1. **Title renamed:** "⚡ STATE CHANNELS" → "⚡ APP SESSIONS" in PositionsPanel
2. **Dynamic separator width:** Added `panelWidth` prop to PositionsPanel, computed as `Math.floor(columns/2) - 4` in App.tsx, used for separator `'─'.repeat(panelWidth)` instead of hardcoded 54
3. **Border overlap fix:** Added `borderLeft={false}` to SystemInfo.tsx and EventLog.tsx outer Box — eliminates double-line where left column's right border meets right column's left border

### Pre-existing bug also fixed
- `mm.routes.test.ts` "disconnected" test was failing because it expected `isConnected()` gate in mm.routes.ts, but that was removed during the lazy-connect refactor. Updated test to match actual lazy-connect behavior (getBalance auto-connects).

### Files Modified
- `hub/src/api/oracle.routes.ts` — Status update + broadcasts moved outside try/catch for losers AND winners
- `hub/src/api/oracle.routes.test.ts` — Added SESSION_SETTLED assertion to Clearnode-failure test
- `hub/src/api/mm.routes.test.ts` — Fixed pre-existing test to match lazy-connect behavior
- `dashboard/src/components/PositionsPanel.tsx` — Renamed title, added panelWidth prop, dynamic separator
- `dashboard/src/App.tsx` — Computed + passed leftPanelWidth
- `dashboard/src/components/SystemInfo.tsx` — Added borderLeft={false}
- `dashboard/src/components/EventLog.tsx` — Added borderLeft={false}

### Test Results
- **Hub:** 18 suites, 233 passed (6 skipped)
- **Dashboard:** 1 suite, 47 passed
- **Hub build:** ✅ clean
- **Dashboard build:** ✅ clean

--- 2026-02-06: Dashboard WebSocket Message Queue Fix ---
- ROOT CAUSE FOUND: Dashboard was dropping WebSocket messages due to React state batching.
  When two WS messages arrived in the same event loop tick, setLastMessage() was called twice
  but React batched them, keeping only the last value. This caused loser SESSION_SETTLED
  messages to be silently dropped (winner's SESSION_SETTLED overwrote loser's).
- FIX: Replaced useState-based lastMessage in useWebSocket.ts with a ref-based message queue.
  Messages are pushed to messageQueueRef.current, and a queueVersion counter triggers re-renders.
  App.tsx drains the queue with splice(0) in useEffect, processing ALL messages in order.
- Also reverted borderLeft={false} on EventLog and SystemInfo panels (left borders restored).
- Files changed: useWebSocket.ts, App.tsx, SystemInfo.tsx, EventLog.tsx
- All 47 dashboard tests pass, TypeScript builds clean.

--- 2026-02-06: Sport Routes Tests ---
- Created comprehensive test suite for sport.routes.ts
- Tests cover GET /api/sports (returns all seeded sports with expected fields)
- Tests cover GET /api/sports/:sportId/categories for baseball (2 categories), basketball (2 categories), soccer (1 category)
- Tests verify 404 for non-existent sport and empty array for sport with no categories
- All 8 tests pass
- Files created: hub/src/api/sport.routes.test.ts


--- 2026-02-06: User Routes Tests ---
- Created comprehensive test suite for user.routes.ts (13 tests)
- Tests cover GET /api/users/:address (404 for unknown, returns stats, all fields present, correct stats after wins/losses)
- Tests cover GET /api/users/:address/history (empty array for no history, settlement history after full market lifecycle, multiple settlements)
- Tests cover GET /api/leaderboard (empty array when no users, sorted by netPnl DESC, respects limit parameter, defaults to 10)
- All tests use full market lifecycle to create settlement history: createMarket → openMarket → addPosition → closeMarket → resolveMarket → clearPositions
- All 13 tests pass
- Files created: hub/src/api/user.routes.test.ts
- Total test count: Hub 246 passed (was 233, +13)

--- 2026-02-06: Game Routes Tests ---
- Created comprehensive test suite for game.routes.ts (19 tests)
- Tests cover GET /api/games (all games, filter by sportId, filter by status)
- Tests cover POST /api/games (auto-generated ID, custom ID, missing required fields validation)
- Tests cover GET /api/games/:gameId (returns game with markets, 404 for non-existent, includes markets array, empty markets when none exist)
- Tests cover POST /api/games/:gameId/activate (activates SCHEDULED game, validates status transitions, sets startedAt timestamp)
- Tests cover POST /api/games/:gameId/complete (completes ACTIVE game, validates status transitions, sets completedAt timestamp)
- All tests use seeded sports (baseball, basketball, soccer) to satisfy foreign key constraints
- All 19 tests pass
- Files created: hub/src/api/game.routes.test.ts
- Total test count: Hub 265 passed (was 246, +19)

Key learnings:
- Games table has foreign key reference to sports table, so sportId must exist before creating a game
- Market categories also have foreign key to sports, so categoryId must exist for the sport
- Default test context seeds baseball, basketball, and soccer sports with various categories
- GameManager enforces strict status transitions: SCHEDULED → ACTIVE → COMPLETED (no backwards)

--- 2026-02-06: SQLite DB Integration COMPLETE ---

## Full summary of SQLite Database Integration (feature/sqlite-db branch)

All 12 steps of the plan are complete. Work done in git worktree at ../pulse-play-sqlite.

### What was built:
1. **DB Module** (packages/hub/src/db/) — 7 Drizzle tables: sports, market_categories, games, markets, positions, users, settlements. Schema push for hackathon (no migrations). WAL mode + FK enforcement in production, in-memory for tests.
2. **MarketManager refactored** — DB-backed with auto-generated market IDs ({gameId}-{categoryId}-{seqNum}), getCurrentMarket by game+category query, market history
3. **PositionTracker refactored** — DB-backed with settlement archival (clearPositions copies to settlements before delete)
4. **GameManager** (new) — CRUD for games with status machine: SCHEDULED → ACTIVE → COMPLETED
5. **UserTracker** (new) — User stats aggregation (bets, wins, losses, P&L), leaderboard, settlement history
6. **Oracle routes updated** — Accept gameId/categoryId, validate outcomes against category's outcomeA/outcomeB
7. **3 new API route files** — sport.routes.ts, game.routes.ts, user.routes.ts + tests
8. **PROJECT_SPECIFICATION.md updated** — New data models, API contracts, removed items from "out of scope"

### Test results:
- 24 test suites, 323 tests passing, 6 skipped (clearnode session tests)
- All existing tests migrated to DB-backed managers with zero behavioral regressions

### Files created (new):
- packages/hub/src/db/schema.ts, connection.ts, seed.ts, index.ts, db.test.ts
- packages/hub/src/modules/game/types.ts, manager.ts, manager.test.ts, index.ts
- packages/hub/src/modules/user/types.ts, tracker.ts, tracker.test.ts, index.ts
- packages/hub/src/api/sport.routes.ts, sport.routes.test.ts
- packages/hub/src/api/game.routes.ts, game.routes.test.ts
- packages/hub/src/api/user.routes.ts, user.routes.test.ts

### Files modified:
- packages/hub/package.json (drizzle-orm, better-sqlite3 deps)
- packages/hub/src/modules/lmsr/types.ts (Outcome → string)
- packages/hub/src/modules/market/types.ts, manager.ts, manager.test.ts
- packages/hub/src/modules/position/tracker.ts, tracker.test.ts
- packages/hub/src/context.ts, server.ts, app.ts
- packages/hub/src/api/oracle.routes.ts, admin.routes.ts, bet.routes.ts + all route tests
- PROJECT_SPECIFICATION.md

### Next steps:
- Merge feature/sqlite-db into main

---

## Frontend/Dashboard/Simulator Compatibility Refactoring
Date: 2026-02-06

### Problem
The SQLite DB integration changed the hub backend API in breaking ways:
1. `POST /api/oracle/market/open` now **requires** `{ gameId, categoryId }` (was empty body)
2. `POST /api/oracle/outcome` now returns `{ winners: number, losers: number }` (was `string[]` arrays)
3. `Outcome` type widened from `'BALL' | 'STRIKE'` to `string` for multi-sport support
4. Market IDs now auto-generated as `{gameId}-{categoryId}-{seqNum}` instead of `market-1`

### Changes Made

#### All Packages — `Outcome` type widened
- `frontend/src/lib/types.ts`: `Outcome = string`
- `dashboard/src/types.ts`: `Outcome = string`
- `simulator/src/types.ts`: `Outcome = string`

#### Frontend
- **types.ts**: `MarketOpenRequest` changed from `{ pitchId? }` to `{ gameId, categoryId }`. `OutcomeResponse` changed from `winners: string[]` to `winners: number`.
- **api.ts**: `openMarket()` requires `MarketOpenRequest` (no default). Added `createGame()`, `activateGame()`, `getGames()` API functions.
- **MarketControls.tsx**: Uses `useRef` for `gameIdRef`. On "Open Market", auto-creates a game (baseball, Demo Home vs Demo Away) and activates it if needed, then opens market with `{ gameId, categoryId: 'pitching' }`. Resolve result uses `result.winners` (number) directly instead of `.length`.
- **GameControls.tsx** (new): Separate component for game state (active/inactive) toggle.
- **GameControls.test.tsx** (new): 5 tests for game state control.
- **MarketControls.test.tsx**: Updated resolve mock from `winners: ['0x111']` to `winners: 1`. Added `createGame`/`activateGame` mocks.
- **api.test.ts**: Updated `openMarket` test from `{ pitchId }` to `{ gameId, categoryId }`.

#### Dashboard
- **types.ts**: `Outcome = string`
- **formatters.ts**: `getOutcomeColor()` now handles multi-sport outcomes (BALL, MAKE, GOAL, HIT → cyan). `formatOutcomeShort()` uses first 4 chars for outcomes longer than 4 characters.
- **formatters.test.ts**: Updated `STRIKE` abbreviation from `STRK` to `STRI`.

#### Simulator
- **types.ts**: `Outcome = string`
- **hub-client.ts**: `openMarket(gameId, categoryId)` — requires params, returns `{ success, marketId }`. `closeMarket()` returns `{ success, marketId }`. `resolveMarket()` returns `{ success, marketId, outcome, winners, losers, totalPayout }`. Added `createGame()` and `activateGame()`.
- **hub-client.test.ts**: All oracle tests updated for new signatures/return types. Added createGame/activateGame tests.
- **App.tsx**: `:open` command now creates game + activates + opens market. Uses `res.marketId` instead of `res.market.id`.

### Test Results
- **Hub:** 24 suites, 323 passed (6 skipped)
- **Frontend:** 24 suites, 185 passed
- **Dashboard:** 1 suite, 47 passed
- **Simulator:** 5 suites, 108 passed
- **Total:** 54 suites, 663 tests passing

### Backward Compatibility Notes
- `POST /api/oracle/market/close` and `POST /api/oracle/outcome` still work WITHOUT `gameId`/`categoryId` (falls back to latest non-RESOLVED market)
- `POST /api/oracle/market/open` is NOT backward compatible — requires both params
- Frontend/simulator auto-create games transparently when opening markets

---

## Fix Hub Test Files After N-Outcome LMSR Generalization
Date: 2026-02-06

### Problem
After generalizing the LMSR engine and DB schema from binary (qBall/qStrike, outcomeA/outcomeB) to N-outcome arrays (quantities[], outcomes[]), several test files still referenced the old field names and API shapes, causing test failures.

### Changes Made

1. **`api/bet.routes.test.ts`**
   - `market.qBall` -> `market.quantities[0]` (line 111)
   - Updated test title from "not BALL or STRIKE" to "not in category outcomes"
   - ODDS_UPDATE broadcast assertion: added `prices`, `quantities`, `outcomes` array expectations

2. **`api/market.routes.test.ts`**
   - `updateQuantities(market.id, 10, 0)` -> `updateQuantities(market.id, [10, 0])` (two occurrences)

3. **`api/oracle.routes.test.ts`**
   - ODDS_UPDATE broadcast assertion: added `prices`, `quantities`, `outcomes` fields alongside backward-compat `priceBall`/`priceStrike`/`qBall`/`qStrike`

4. **`api/sport.routes.test.ts`**
   - `pitching.outcomeA`/`pitching.outcomeB` -> `pitching.outcomes` (toEqual array)
   - Same for `freeThrow`, `threePointer`, and `penalty` categories

5. **`modules/user/tracker.test.ts`**
   - Market insert: `qA: 0, qB: 0` -> `quantities: JSON.stringify([0, 0])`

6. **`modules/position/tracker.test.ts`**
   - Market insert helper: `qA: 0, qB: 0` -> `quantities: JSON.stringify([0, 0])`

7. **`__tests__/integration.test.ts`**
   - `market.qBall`/`market.qStrike` -> `market.quantities[0]`/`market.quantities[1]`

8. **`db/db.test.ts`** (discovered during test run, not in original list)
   - `pitching.outcomeA`/`outcomeB` -> `JSON.parse(pitching.outcomes)` (toEqual array)
   - Same for `freeThrow` and `penalty` categories

### Files NOT needing changes (confirmed clean)
- `api/positions.routes.test.ts` — no old-style references
- `api/game.routes.test.ts` — no old-style references
- `api/admin.routes.test.ts` — already using correct shapes

### Test Results
- **Hub:** 24 suites passed (1 skipped), 338 tests passed (6 skipped — pre-existing Clearnode session tests)
- Zero failures

---

## Multi-Market Frontend + N-Outcome LMSR Generalization — COMPLETE
Date: 2026-02-06

### Summary
All 12 steps of the multi-market frontend plan are complete. The frontend has been transformed from a single hardcoded baseball/pitching market to a multi-sport, multi-game, multi-category platform with dynamic N-outcome support.

### Steps Completed (in this session — Steps 5-12):

**Step 5: Frontend Types + API Client Updates**
- Rewrote `types.ts` with new domain models: Sport, MarketCategory, Game, UserStats, Settlement
- Updated MarketData with `quantities[]`, `prices[]`, `outcomes[]` (+ backward compat)
- Added 15+ new API functions: getMarketById, getSports, getSportCategories, getGames, getGame, createGame, activateGame, completeGame, getAdminPositions, getUserStats, getUserHistory, getLeaderboard
- 31 API tests

**Step 6: SelectedMarketProvider**
- New context provider that takes `marketId` prop, fetches via `getMarketById`
- Subscribes to WS filtered by marketId (ODDS_UPDATE, MARKET_STATUS)
- Replaces MarketProvider for per-market subscriptions
- 8 tests

**Step 7: Adapt Bettor Components for N Outcomes**
- OddsDisplay, BetForm, PositionList all use `useSelectedMarket()` with dynamic outcome rendering
- OUTCOME_COLORS array cycles for any N outcomes
- Oracle components (MarketControls, GameControls, StateDisplay) updated for new context
- All component tests updated

**Step 8: Home Page — Game Browser**
- New components: SportFilter, GameCard, GameList
- Home page (`/`) shows game grid with sport filtering
- Auto-refreshes via WebSocket GAME_STATE and MARKET_STATUS events
- 26 tests

**Step 9: Game Detail Page (`/game/[gameId]`)**
- New components: GameHeader, MarketSelector
- Dynamic route page wraps betting components in SelectedMarketProvider
- Category pills with market status badges
- Auto-refreshes via WebSocket
- 18 tests

**Step 10: Oracle Page Redesign**
- New components: GameSelector (with inline create-game form), CategorySelector
- GameControls rewritten to accept Game prop (Activate/Complete lifecycle)
- Full flow: select/create game → select category → game controls + market controls + odds
- 15 tests for new components, 34 total oracle tests

**Step 11: Admin Page (`/admin`)**
- New components: AdminTabs, SportsPanel, GamesPanel, MarketsPanel, UsersPanel, LeaderboardPanel
- Tab-based navigation: Sports | Games | Markets | Users | Leaderboard
- SportsPanel: expandable categories with outcome badges
- GamesPanel: status filters, create game, activate/complete actions
- MarketsPanel: game dropdown → markets → expandable positions
- UsersPanel: leaderboard with expandable settlement history
- LeaderboardPanel: ranked table with top-3 indicators
- 18 tests

**Step 12: Navigation + Cleanup**
- Header: "Bettor" renamed to "Games", "Admin" link added
- Build verified: `next build` passes cleanly
- MarketProvider type fix: added gameId, categoryId, quantities to fallback branch
- All lint/type errors resolved

### Test Results
- **Hub:** 24 suites, 338 passed (6 skipped)
- **Frontend:** 37 suites, 296 passed
- **Dashboard:** 47 passed (unchanged)
- **Simulator:** 106+ passed (unchanged)
- **Frontend build:** ✅ clean
- **Total:** 780+ passing tests

### New Frontend Pages
| Route | Description |
|---|---|
| `/` | Game browser with sport filtering |
| `/game/[gameId]` | Game detail with category selection + betting |
| `/oracle` | Oracle: game management, market lifecycle, resolution |
| `/admin` | Admin: sports, games, markets, users, leaderboard |
| `/market-maker` | Market maker: balance + faucet (unchanged) |
| `/account` | Account: session, faucet, balance (unchanged) |

### New Frontend Components
| Component | Path |
|---|---|
| SportFilter | `components/games/SportFilter.tsx` |
| GameCard | `components/games/GameCard.tsx` |
| GameList | `components/games/GameList.tsx` |
| GameHeader | `components/games/GameHeader.tsx` |
| MarketSelector | `components/games/MarketSelector.tsx` |
| GameSelector | `components/oracle/GameSelector.tsx` |
| CategorySelector | `components/oracle/CategorySelector.tsx` |
| AdminTabs | `components/admin/AdminTabs.tsx` |
| SportsPanel | `components/admin/SportsPanel.tsx` |
| GamesPanel | `components/admin/GamesPanel.tsx` |
| MarketsPanel | `components/admin/MarketsPanel.tsx` |
| UsersPanel | `components/admin/UsersPanel.tsx` |
| LeaderboardPanel | `components/admin/LeaderboardPanel.tsx` |

### Backward Compatibility
- All API responses and WS messages include BOTH old format (priceBall/priceStrike/qBall/qStrike) and new array format (prices[], quantities[], outcomes[])
- Dashboard and simulator continue to work using old field names
- Old MarketProvider still exists (for backward compat) but removed from global layout
- Frontend exclusively uses new array fields via SelectedMarketProvider

### What dashboard/simulator need to be updated for (next agent):
- Dashboard/simulator still use `priceBall`/`priceStrike`/`qBall`/`qStrike` fields
- These work fine for 2-outcome markets (backward compat fields populated)
- For 3+ outcome markets, old fields default to first 2 elements (degraded display)
- To fully support N outcomes: update to use `prices[]`/`quantities[]`/`outcomes[]` arrays
- Dashboard LMSR price calculations need updating to use N-outcome engine

---

## Frontend: Auto-reconnect Clearnode WebSocket
Date: 2026-02-06

### Problem
Clearnode WebSocket server drops idle connections. Frontend had no recovery — `assertReady()` in
`methods.ts` just threw, making bets permanently fail until manual page refresh. Backend already
solved this with `ensureConnected()` lazy-connect pattern.

### Key Insight
ECDSA session signer survives WebSocket reconnections. If signer hasn't expired, only a new
WebSocket is needed — no re-authentication, no MetaMask popup. Full re-auth only when session
has actually expired.

### Solution: Two-tier auto-reconnect in ClearnodeProvider
1. **Detection**: Added `onclose`/`onerror` handlers on WebSocket after auth and after light reconnect.
   Status goes to 'disconnected' but signer/expiresAt are preserved (not nulled).
2. **Recovery**: `ensureConnected()` called before every method callback:
   - Signer valid + WS dead → `reconnectWsOnly()` (opens WS only, no MetaMask)
   - Signer expired/null → `authenticate()` (full 3-step auth, MetaMask popup)
   - Concurrent calls → deduplicated via `connectPromiseRef`
3. **Stale closure fix**: Method callbacks use `signerRef.current` (ref) instead of `signer` (state).
   Dependencies changed from `[signer, ...]` to `[ensureConnected, ...]`.

### Implementation Details
- Added 3 refs: `signerRef`, `expiresAtRef`, `connectPromiseRef`
- Refs synced everywhere state is set (auth success/failure, reconnect, disconnect, cleanup effect)
- `authenticate()` now re-throws errors (callers wrapped in try/catch where needed)
- `refreshBalance` uses refs but does NOT auto-reconnect (passive polling)
- `getConfig` (no signer needed) still calls `ensureConnected()` for WS readiness

### Files Modified
- `packages/frontend/src/providers/ClearnodeProvider.tsx` — Refs, reconnectWsOnly, ensureConnected,
  updated method callbacks, onclose/onerror handlers, authenticate re-throws
- `packages/frontend/src/providers/ClearnodeProvider.test.tsx` — 6 new tests

### New Tests
1. Light reconnects (WS only) when signer is still valid
2. Full re-auth when signer has expired
3. Deduplicates concurrent reconnection attempts
4. Status updates to disconnected when WS close event fires (signer preserved)
5. Method returns correct result after light reconnect
6. Error propagates when reconnection fails

### Test Results
- **Frontend:** 24 suites, 191 passed (was 185, +6 new)
- **No changes** to methods.ts, rpc.ts, auth.ts, types.ts, or useBet.ts

---

## Fix: Clearnode Connection Dropping + Winner Payout Missing
Date: 2026-02-06

### Bug 1: Connection keeps dropping (frontend)
**Root cause:** `useBet.ts` gated on `clearnodeStatus !== 'connected'` before calling `createAppSession`. When the Clearnode WS dropped (normal idle timeout), status went to `'disconnected'` and bets were rejected immediately — `createAppSession`'s built-in `ensureConnected()` (which handles transparent reconnection) was never reached.

**Fix:**
- Removed `clearnodeStatus` check (lines 52-57), destructure, and dependency from `useBet.ts`
- `createAppSession` already calls `ensureConnected()` internally which does light WS-only reconnect if signer is valid, or full re-auth if expired
- Replaced the "Clearnode not connected" test with a test verifying bets succeed via transparent reconnection when status is 'disconnected'

### Bug 2: Winner doesn't receive winnings from market maker
**Root cause (allowances):** `server.ts` created ClearnodeClient with `allowances: []`, overriding the default allowance in `auth.ts`. The MM's session key had no asset allowance, so `transfer()` (which sends profit from MM ledger to winner) failed silently.

**Root cause (error handling):** Winner settlement had `closeSession` and `transfer` in a single try/catch. When `transfer` failed, the error was caught but the user still saw "You Won!" (BET_RESULT sent outside try/catch). User got their bet back from `closeSession` but the profit from `transfer` was lost.

**Fixes:**
1. `server.ts` — Changed `allowances: []` to `allowances: [{ asset: 'ytest.usd', amount: '100000000000' }]` ($100k)
2. `oracle.routes.ts` — Separated winner `closeSession` and `transfer` into individual try/catch blocks with specific error labels (`resolution-winner-closeSession-*` and `resolution-winner-transfer-*`)
3. Added test: "winner gets BET_RESULT even when transfer fails" verifying error isolation and specific error logging

### Files Modified
- `packages/frontend/src/hooks/useBet.ts` — Removed `clearnodeStatus` gate
- `packages/frontend/src/hooks/useBet.test.ts` — Replaced "not connected" test with reconnection test
- `packages/hub/src/server.ts` — Added proper allowances to ClearnodeClient
- `packages/hub/src/api/oracle.routes.ts` — Separate try/catch for closeSession vs transfer
- `packages/hub/src/api/oracle.routes.test.ts` — Added partial settlement failure test

### Test Results
- **Hub:** 17 suites, 233 passed (+1 new oracle test), 1 pre-existing integration timeout (unrelated)
- **Frontend:** 24 suites, 191 passed (test count unchanged — replaced 1 test with 1 test)

---

## Fix: Clearnode WS Disconnect Leaking Into UI
Date: 2026-02-06

### Problem
When Clearnode WebSocket drops (normal idle timeout), `ClearnodeProvider` sets `status` to `'disconnected'`. UI components gated on `status === 'connected'` showed wrong states:
1. **AccountBalanceCard** showed "Connect wallet to view balance" despite having cached balance
2. **SessionCard** badge flipped to "Not Authenticated" despite valid signer
3. **refreshBalance** early-returned when WS dead (couldn't refresh)

### Fix 1: refreshBalance auto-reconnects
- Added `await ensureConnected()` at top of `refreshBalance` (wrapped in try/catch)
- Moved `refreshBalance` definition after `ensureConnected` to avoid reference-before-definition
- Dependency array changed from `[]` to `[ensureConnected]`

### Fix 2: AccountBalanceCard gates on balance not status
- Replaced `status === 'connected'` check with `balance === null`
- Balance is set after first auth, preserved on WS drop, only cleared on explicit disconnect
- Pulls `balance` + `refreshBalance` from context (dropped `status`)

### Fix 3: SessionCard decoupled from WS liveness
- `getStatusBadge()` now takes `expiresAt` as third parameter
- Priority: transitional states → error → `isSessionValid` (Active) → `expiresAt > 0 && !valid` (Expired) → fallthrough (Not Authenticated)
- Expiry section guard changed from `status === 'connected'` to `expiresAt > 0`

### Files Modified
- `packages/frontend/src/providers/ClearnodeProvider.tsx` — refreshBalance calls ensureConnected, moved after ensureConnected definition
- `packages/frontend/src/components/account/AccountBalanceCard.tsx` — Gate on `balance !== null` not `status`
- `packages/frontend/src/components/account/SessionCard.tsx` — Badge + expiry decoupled from WS status

### Tests Updated
- `ClearnodeProvider.test.tsx` — +2 tests (refreshBalance auto-reconnect, reconnect failure non-fatal)
- `AccountBalanceCard.test.tsx` — Updated "not-connected" to gate on `balance: null`, changed "null balance" to "zero balance", +1 test (disconnected with cached balance)
- `SessionCard.test.tsx` — +2 tests (Active when disconnected but valid, Expired badge when signer expires)

### Test Results
- **Frontend:** 24 suites, 196 passed (was 191, +5 new)

---

## Fix: "authentication required" After Clearnode WS Idle Disconnect
Date: 2026-02-06

### Root Cause
After a few minutes idle, the Clearnode server drops the WebSocket. `ensureConnected()` detected the dead WS and took a "light reconnect" path (`reconnectWsOnly()`), which opened a **raw, unauthenticated WebSocket** — it never sent the 3-step EIP-712 auth handshake. The Clearnode server binds auth state per-WebSocket, so it rejected the next RPC call with `{"error":"authentication required"}`.

### Fix: Two Changes

**1. WebSocket keepalive heartbeat**
- Added `useEffect` that sends `createGetConfigMessageV2()` (lightest RPC, no signer needed) every 30s while WS is OPEN
- Uses `wsRef` (ref) — no React state dependency, interval runs for provider lifetime
- Prevents the Clearnode server's idle timeout from ever triggering
- Send failures silently caught (non-fatal)

**2. Removed broken `reconnectWsOnly`, simplified `ensureConnected`**
- Deleted `reconnectWsOnly` — it opened a new WS without authentication, fundamentally broken
- Simplified `ensureConnected` to always call `authenticate()` when WS is dead (full 3-step handshake)
- This matches the hub's behavior where every reconnect does full auth
- Concurrent reconnection attempts still deduplicated via `connectPromiseRef`

### Files Modified
- `packages/frontend/src/providers/ClearnodeProvider.tsx` — Added `createGetConfigMessageV2` import, keepalive `useEffect`, deleted `reconnectWsOnly`, simplified `ensureConnected`
- `packages/frontend/src/providers/ClearnodeProvider.test.tsx` — Updated 4 reconnect tests (now verify full auth), added 1 keepalive test

### Test Updates
- Renamed "light reconnects (WS only)" → "reconnects with full auth when WS drops" — asserts `authenticateBrowser` called 2x
- Renamed "method returns correct result after light reconnect" → "after reconnect" — added auth mock
- Updated dedup test and refreshBalance reconnect test to include auth mocks
- Added "sends keepalive get_config message every 30 seconds" test using fake timers

### Test Results
- **Frontend:** 24 suites, 197 passed (was 196, +1 new keepalive test)

---

## Fix: Intermittent Faucet Funding Failures
Date: 2026-02-06

### Problem
When the simulator runs `:fund` for 10+ wallets, concurrent HTTP requests to the external sandbox faucet cause 503/500 errors. No retry logic and no concurrency control at any level.

### Solution: Three Layers

**Layer 1 — Retry with exponential backoff** (`faucet.ts`)
- Max 3 retries (4 total attempts)
- Backoff: 500ms base, doubling each retry, capped at 5s
- 0-20% random jitter to prevent thundering herd
- Retry on 5xx and network TypeError; throw immediately on 4xx
- `console.warn` for retries (suppressed in test via `NODE_ENV`)

**Layer 2 — Global request serialization queue** (`faucet.ts`)
- `requestFaucetQueued()` chains onto a module-level promise
- Only one HTTP request to external faucet in-flight at a time
- `_resetFaucetQueue()` exported for test cleanup
- Both `faucet.routes.ts` and `client.ts` switched to `requestFaucetQueued`

**Layer 3 — Reduced simulator concurrency** (`simulator/App.tsx`)
- `BATCH_SIZE` reduced from 5 to 2
- 1000ms inter-batch delay (skipped after last batch)

### Files Modified
- `packages/hub/src/modules/clearnode/faucet.ts` — Retry + queue implementation
- `packages/hub/src/modules/clearnode/faucet.test.ts` — **New** — 10 tests (7 retry + 3 queue)
- `packages/hub/src/api/faucet.routes.ts` — Import `requestFaucetQueued as requestFaucet`
- `packages/hub/src/api/faucet.routes.test.ts` — Mock exports `requestFaucetQueued`
- `packages/hub/src/modules/clearnode/client.ts` — Import + use `requestFaucetQueued`
- `packages/hub/src/modules/clearnode/client.test.ts` — Mock exports `requestFaucetQueued`
- `packages/simulator/src/App.tsx` — BATCH_SIZE=2, 1s inter-batch delay

### Test Results
- **Hub:** 19 suites, 244 passed (was 233, +10 new faucet tests, 1 suite skipped)
- **Simulator:** 5 suites, 106 passed (unchanged)
- **Total hub+sim:** 350 passing tests

---

## Rich sessionData Across App Session Lifecycle
Date: 2026-02-06

### What was done:
Implemented a 3-version sessionData lifecycle that makes each Clearnode app session self-describing:
- **V1** (bettor creates session): bet intent — marketId, outcome, amount, timestamp
- **V2** (hub accepts bet): LMSR confirmation — shares, effectivePricePerShare, pre/post-bet odds
- **V3** (hub settles): resolution — result (WIN/LOSS), payout, profit, shares, costPaid

### Hub Changes

1. **session-data.ts** (NEW) — `SessionDataV1`, `SessionDataV2`, `SessionDataV3` types + `encodeSessionData`/`decodeSessionData` helpers
2. **session-data.test.ts** (NEW) — 6 tests (round-trip V1/V2/V3, version discrimination, valid JSON, invalid JSON throws)
3. **tracker.ts** — Added `updateAppSessionVersion(appSessionId, version)` method
4. **tracker.test.ts** — +2 tests (version update + no-op on unknown)
5. **bet.routes.ts** — Captures pre-bet odds, builds V2 SessionData after bet acceptance, calls `submitAppState` with V2 sessionData (non-fatal try/catch), updates appSessionVersion on success
6. **bet.routes.test.ts** — +4 tests (V2 sessionData content, V2 failure non-fatal, version updated on success, version unchanged on failure)
7. **oracle.routes.ts** — Builds V3 SessionData for losers (submitAppState + closeSession) and winners (closeSession), includes resolution, result, payout, profit
8. **oracle.routes.test.ts** — +3 tests (loser submitAppState V3, loser closeSession V3, winner closeSession V3). Updated existing "calls submitAppState + closeSession for losers" test to clear mocks before resolution.
9. **logger.ts** — Added `betSessionDataUpdated()` and `betSessionDataFailed()` methods
10. **logger.test.ts** — Updated both test blocks with new logger methods

### Frontend Changes

1. **lib/clearnode/session-data.ts** (NEW) — `SessionDataV1` type + `encodeSessionData` helper (V1 only, client-side)
2. **lib/clearnode/index.ts** — Added session-data export
3. **hooks/useBet.ts** — Builds V1 sessionData before `createAppSession`, passes `sessionData: encodeSessionData(v1Data)`
4. **hooks/useBet.test.ts** — +1 test (V1 sessionData contains marketId, outcome, amount). Updated existing "full success flow" to use `objectContaining` for new sessionData field.

### Simulator Changes

1. **core/clearnode-pool.ts** — Added optional `sessionData?: string` parameter to `createAppSession`, passes to SDK as `session_data`
2. **core/simulation-engine.ts** — Builds V1 sessionData object, passes `JSON.stringify(v1Data)` to `createAppSession`
3. **core/clearnode-pool.test.ts** — +1 test (sessionData passed to SDK)
4. **core/simulation-engine.test.ts** — +1 test (V1 sessionData content verified)

### Bug Fix (pre-existing)
- **AccountBalanceCard.test.tsx** — Updated expected text from "Connect wallet to view balance" to "Authenticate to view balance" (matching component)

### Design Decisions
1. V2 is non-fatal: If Clearnode `submitAppState` for V2 fails, the bet is still accepted internally
2. V2 allocations unchanged: No fund reallocation at V2, only sessionData enrichment
3. Version tracking: Position's `appSessionVersion` updated after V2 success, so V3 uses correct next version regardless of V2 outcome
4. Types duplicated across packages (not shared): Hub, frontend, simulator each have their own copy — small and stable

### Test Results
- **Hub:** 20 suites, 259 passed (was 244, +15 new: 6 session-data + 2 tracker + 4 bet + 3 oracle)
- **Frontend:** 24 suites, 198 passed (was 197, +1 new useBet V1 test)
- **Simulator:** 5 suites, 108 passed (was 106, +2 new: 1 pool + 1 engine)
- **Dashboard:** 1 suite, 47 passed (unchanged)
- **Total:** 612 passing tests

---

## SESSION_VERSION_UPDATED WebSocket Broadcast
Date: 2026-02-06

### Problem
After a bet is accepted, the hub updates `appSessionVersion` from 1 to 2 via `updateAppSessionVersion()` in `bet.routes.ts`. However, no WebSocket broadcast notified the dashboard of this version change. The VERSION column stayed at 1 until resolution.

### What was done
1. **New `SESSION_VERSION_UPDATED` WS message type** — Added to hub `types.ts`, dashboard `types.ts`, and frontend `types.ts` (type parity)
2. **Hub broadcast** — After successful V2 `submitAppState`, broadcasts `{ type: 'SESSION_VERSION_UPDATED', appSessionId, version }` via `ctx.ws.broadcast()`
3. **Dashboard handler** — `App.tsx` processes `SESSION_VERSION_UPDATED` to update the matching position's `appSessionVersion` in real-time
4. **Dashboard formatter** — `formatWsMessage()` formats the new type for the event log
5. **Column rename** — PositionsPanel column header changed from `v` (4-char) to `VERSION` (9-char) with matching data cell padding
6. **Tests** — +2 hub tests (broadcast on success, no broadcast on failure), +1 dashboard formatter test

### Test Results
- **Hub:** 20 suites, 261 passed (+2 new SESSION_VERSION_UPDATED broadcast tests)
- **Dashboard:** 1 suite, 48 passed (+1 new formatter test)
- **Frontend:** 24 suites, 198 passed (unchanged, type parity only)

---

## Fix: Missing V3 SESSION_VERSION_UPDATED Broadcast for Losers (oracle.routes.ts)
Date: 2026-02-06

### Problem
The `SESSION_VERSION_UPDATED` broadcast was only implemented for the V1→V2 transition in `bet.routes.ts`. When the market resolves, losers go through `submitAppState` with V3 data in `oracle.routes.ts`, but no `SESSION_VERSION_UPDATED` was broadcast and `updateAppSessionVersion` was never called on the tracker. The dashboard never learned about V2→V3 for losers.

### What was done
1. **V3 version update + broadcast for losers** — After successful V3 `submitAppState` in the loser settlement loop (`oracle.routes.ts`), added `positionTracker.updateAppSessionVersion()` and `ws.broadcast({ type: 'SESSION_VERSION_UPDATED' })`, mirroring the V2 pattern in `bet.routes.ts`. Placed inside the try block so it only fires if `submitAppState` succeeds.
2. **+2 tests** — `broadcasts SESSION_VERSION_UPDATED for losers after V3 submitAppState` and `does not broadcast SESSION_VERSION_UPDATED for losers when V3 submitAppState fails`

### Notes
- Winners don't get V3 `submitAppState` — they go straight to `closeSession` + `transfer`. No version increment for winners (by design).
- Dashboard `App.tsx` already handles `SESSION_VERSION_UPDATED` generically, so no frontend changes needed.

### Test Results
- **Hub:** 20 suites, 263 passed (+2 new V3 broadcast tests)

---

## 2026-02-07: Dashboard Multi-Sport / N-Outcome Upgrade

### Changes
- **types.ts**: `WsOddsUpdate` now uses `prices[]`, `quantities[]`, `outcomes[]` (required); old `priceBall`/`priceStrike`/`qBall`/`qStrike` kept as optional backward compat. `AdminStateResponse.market` now has `quantities[]`, `outcomes[]`, `gameId?`, `categoryId?`. Top-level `prices[]` and `outcomes[]` on `AdminStateResponse`.
- **formatters.ts**: `calculatePrices()` extracted as pure function (LMSR softmax with log-sum-exp trick). `formatWsMessage()` ODDS_UPDATE uses N-outcome formatting. `getOutcomeColor()` accepts optional index for color cycling. `formatVersion()` bug fixed (was returning `"1"` instead of `"v1"`).
- **App.tsx**: State changed from `{priceBall, priceStrike}` to `prices: number[]`, `outcomes: string[]`, `quantities: number[]`. All message handlers updated for N-outcome. Added `:games` and `:sports` commands.
- **MarketPanel.tsx**: Dynamic N-outcome rendering with color cycling. Shows `gameId`/`categoryId` in header.
- **SystemInfo.tsx**: Shows Game ID and Category ID when available.
- **CommandBar.tsx**: Shows game/category context in status bar.

### Test Results
- **Dashboard:** 56 tests passed (was 48 — added 8 new: N-outcome ODDS_UPDATE formatting, 3-outcome ODDS_UPDATE, getOutcomeColor index cycling, 6 calculatePrices tests)
- **TypeScript:** Zero compilation errors

## 2026-02-07 — Multi-Sport N-Outcome Migration (Steps 1-13 COMPLETE)

### Dashboard (packages/dashboard/)
- **types.ts**: WsOddsUpdate, AdminStateResponse use `prices[]`, `quantities[]`, `outcomes[]` arrays
- **App.tsx**: State migrated from priceBall/priceStrike to arrays; added `:games` and `:sports` commands
- **MarketPanel.tsx**: Dynamic N-outcome rendering with color cycling
- **formatters.ts**: `getOutcomeColor(outcome, index?)` with OUTCOME_COLORS cycle; `formatWsMessage` uses arrays
- **HelpOverlay.tsx**: Added `:games` and `:sports` commands
- **56 tests passing, build clean**

### Simulator (packages/simulator/)
- **types.ts**: Same array field migration; SimConfig: `outcomeBias` + `outcomes[]` replace `ballBias`
- **App.tsx**: `:open [sportId] [categoryId]` fetches categories for outcomes; `:resolve` validates against outcomes[]
- **MarketPanel.tsx**: Dynamic N-outcome rendering
- **wallet-manager.ts**: `generateProfiles` uses `config.outcomes` and `outcomeBias`
- **hub-client.ts**: Added `getSports()` and `getSportCategories()` methods
- **formatters.ts**: Same generalization as dashboard
- **HelpOverlay.tsx**: Updated command descriptions
- **112 tests passing, TypeScript clean**

### Remaining from plan
- Step 14 (READMEs) — not yet done

---

## 2026-02-07: Transaction Fee Tests Added

### Context
Transaction fee feature was implemented, now adding comprehensive test coverage across bet, admin, and oracle routes.

### Changes Made

#### 1. bet.routes.test.ts (+5 tests)
Added fee-specific tests at end of describe block:
- `V2 allocations include fee split (default 1%)` — Verifies 1% fee on $10 bet splits into $9.9 net + $0.1 fee in allocations
- `V2 sessionData contains fee and feePercent fields` — Confirms sessionData includes fee=0.1 and feePercent=1
- `position records fee amount` — Checks position tracker stores fee=0.1 and costPaid=10
- `LMSR uses netAmount (fewer shares with fee)` — Verifies LMSR getShares() uses net amount after fee deduction
- `zero fee results in no fee split` — Confirms setting transactionFeePercent=0 results in full amount to user

#### 2. admin.routes.test.ts (+6 tests)
Added new `config endpoints` describe block with tests for GET/POST /api/admin/config:
- `GET /api/admin/config returns transactionFeePercent` — Returns default 1%
- `POST /api/admin/config updates transactionFeePercent` — Successfully updates to 2.5%
- `POST /api/admin/config broadcasts CONFIG_UPDATED` — WebSocket broadcast verification
- `POST /api/admin/config returns 400 for invalid value` — Negative value validation
- `POST /api/admin/config returns 400 for value > 100` — Upper bound validation
- `POST /api/admin/config returns 400 for non-number` — Type validation

#### 3. oracle.routes.test.ts (+1 test)
Added to outcome/resolution describe block:
- `winner close session allocates fee to MM (not all to user)` — Verifies winner's closeSession splits $10 bet into $9.9 to user (9900000) and $0.1 to MM (100000), ensuring fee stays with MM

### Test Results
- **All 380 tests passing** (was 368 — added 12 new fee-specific tests)
- Hub test suite: 26 passed suites, 0 failures
- Test execution time: ~21 seconds

### Fee Implementation Verification
Tests confirm:
1. Fee calculation: `feeAmount = amount * (feePercent / 100)`
2. Net amount: `netAmount = amount - feeAmount`
3. LMSR uses netAmount (fewer shares purchased)
4. V2 allocations: `[netAmount, feeAmount]`
5. V2 sessionData includes `fee` and `feePercent` fields
6. Position records both `fee` and `costPaid` (original amount)
7. Winner closeSession splits: `[netAmount to user, fee to MM]`
8. Admin config endpoints work correctly with validation
9. Zero fee bypasses fee split entirely

### Notes
- Fee stays with MM on winner resolution (doesn't go back to user)
- Losers: full amount goes to MM (including fee that was already split at V2)
- Winners: closeSession returns netAmount to user, fee remains with MM
- Config validation: 0 ≤ transactionFeePercent ≤ 100
- Tests use default 1% fee from createTestContext()


---

## Market Maker Fee Implementation
Date: 2026-02-07

### What was done:
1. **AppContext** — Added `transactionFeePercent: number` (default 1%) to `AppContext` interface, `createTestContext`, and `server.ts`
2. **Bet route fee logic** — `feeAmount = amount * (feePercent / 100)`, `netAmount = amount - feeAmount`. LMSR uses `netAmount` for share calculation. V2 allocations split as `[netAmount, feeAmount]` instead of `[amount, 0]`
3. **SessionDataV2** — Added optional `fee` and `feePercent` fields
4. **Position fee tracking** — Added `fee` column to positions table (schema + raw SQL), optional `fee` field on Position type, stored in DB via tracker
5. **Winner resolution fix** — closeSession for winners uses `[netAmount, fee]` allocations (fee stays with MM). Loser logic unchanged (total session amount still moves to MM)
6. **Admin config endpoints** — `GET/POST /api/admin/config` for reading/updating `transactionFeePercent`, broadcasts `CONFIG_UPDATED` WS message
7. **WsMessage type** — Added `CONFIG_UPDATED` message type
8. **Logger** — Added `configUpdated()` method
9. **Frontend MMFeeCard** — New component with preset buttons (0%, 0.5%, 1%, 2%), custom input, save button. Added to market-maker page layout
10. **Frontend API** — `getAdminConfig()` and `updateAdminConfig()` functions

### Tests:
- Hub: 380 tests passing (12 new fee-specific tests)
- Frontend: 319 tests passing (7 new MMFeeCard tests)
- New test coverage: V2 fee allocations, sessionData fee fields, position fee recording, zero-fee mode, admin config CRUD + validation + WS broadcast, winner close allocations with fee, MMFeeCard render/preset/save/error

### Key math:
- Fee: `feeAmount = amount * (feePercent / 100)`
- Net: `netAmount = amount - feeAmount`  
- Shares from LMSR use `netAmount` (fee reduces shares)
- `costPaid` = full `amount` (what user put up)
- Winner total return: `netAmount` (session close) + `profit` (transfer) = `payout - fee`

---

## Dashboard Merged into Simulator
Date: 2026-02-07

### What was done:
Merged `packages/dashboard/` into `packages/simulator/`, then deleted the dashboard package. The simulator was already a superset (wallets, sim engine, oracle commands) — dashboard only had a few unique features that needed porting.

### Features Ported from Dashboard:
1. **PositionsPanel** — App session table (session ID, bettor, bet, allocation, version, status) with scroll support
2. **SystemInfo** — Connection health panel (WS status, client count, game state, positions, session counts) with ink-spinner
3. **`:games` command** — Fetches and lists all games in event log
4. **`:sports` command** — Fetches and lists all sports/categories in event log
5. **WS handlers** — POSITION_ADDED (tracks positions + session counts), SESSION_VERSION_UPDATED (updates version), SESSION_SETTLED (updates status + session counts)

### Changes Made:
- **types.ts** — Added `WsSessionVersionUpdated`, `fee?` on Position, `gameId?`/`categoryId?` on AdminStateResponse.market
- **formatters.ts** — Added `formatVersion`, `formatStatusBadge`, `formatOutcomeShort`, `calculatePrices`, `SESSION_VERSION_UPDATED` case in formatWsMessage, updated SESSION_SETTLED to include appSessionId
- **App.tsx** — Added positions state, 3-panel tab cycling (wallets→positions→eventLog), positions scroll, WS handlers for session lifecycle, :games/:sports commands, SystemInfo in layout, PositionsPanel as alternate left panel
- **PositionsPanel.tsx** — NEW (adapted from dashboard)
- **SystemInfo.tsx** — NEW (simplified from dashboard — removed admin API polling, uses existing WS state)
- **HelpOverlay.tsx** — Added :games/:sports commands
- **package.json** — Added ink-spinner dependency
- **components/index.ts** — Added PositionsPanel, SystemInfo exports
- **formatters.test.ts** — Added 21 new tests (session status colors, formatVersion, formatStatusBadge, formatOutcomeShort, calculatePrices, SESSION_VERSION_UPDATED/SESSION_SETTLED formatting)

### Deleted:
- `packages/dashboard/` — Entire package removed

### Test Results:
- **Simulator:** 5 suites, 133 passed (was ~112, +21 new formatter tests)
- **TypeScript:** Zero compilation errors
- **Workspace:** dashboard no longer listed in `pnpm -r list`

### Branch: feature/dashboard-migration (worktree at ../pulse-play-dashboard-migration)

---

## Simulator Bug Fixes + Enhancements
Date: 2026-02-07

### Bug 1: HelpOverlay center-justified text
**Root cause:** `alignItems="center"` on outer Box centered all children horizontally, misaligning key/description columns.
**Fix:** Removed `alignItems="center"` from outer Box. Added `alignSelf="center"` only on title, separator, and footer elements. Command rows now left-align with `paddingLeft={4}`.
**File:** `simulator/src/components/HelpOverlay.tsx`

### Bug 2: Layout restructure — all panels always visible
**Problem:** Tab cycling between Wallets/Positions meant only one showed at a time. EventLog was in a cramped bottom section.
**New layout:**
- Left column (55%): PositionsPanel (top half) + EventLog (bottom half) — always visible
- Right column (45%): SystemInfo (fixed height) + WalletTable (fills remaining)
- MarketPanel: full-width compact bar above CommandBar
- Tab cycles focus (positions → eventLog → wallets) for scroll/keyboard control only
- Default active panel is now 'positions'
**File:** `simulator/src/App.tsx`

### Bug 3: Wallet balances not updating in real-time
**Root cause:** After bets and resolution, wallet balances only refreshed on manual `:status`.
**Fix:** Added `clearnodePool.getBalance()` calls in two WS handlers:
1. `POSITION_ADDED` — If the bettor is a sim wallet, refresh their balance
2. `SESSION_SETTLED` — If the settled wallet is a sim wallet, refresh their balance
Both wrapped in `.catch()` for non-fatal resilience.
**File:** `simulator/src/App.tsx`

### Bug 4: ResultsPanel shows 0s + merge into MarketPanel
**Root cause:** `computeResults()` fetched from hub API, but hub already cleared positions by that point.
**Fix Part A:** Changed `computeResults()` from async API fetch to synchronous, using local `positions` state via `setPositions()` functional update to access current state.
**Fix Part B:** Added `results` prop to `MarketPanel`. When set and market is RESOLVED, shows compact results summary: outcome + W:count +total / L:count -total. Deleted `ResultsPanel.tsx`, removed from exports.
**Files:** `simulator/src/App.tsx`, `simulator/src/components/MarketPanel.tsx`, `simulator/src/components/ResultsPanel.tsx` (DELETED), `simulator/src/components/index.ts`

### Feature 1: Positions accordion expansion with session data
**Hub changes:**
- `db/schema.ts` + `db/connection.ts`: Added `session_data TEXT` column to positions table
- `modules/position/types.ts`: Added `sessionData?: string` to Position interface
- `modules/position/tracker.ts`: Added `updateSessionData(appSessionId, data)` method; `toPosition()` maps sessionData
- `api/bet.routes.ts`: After V2 submitAppState success, stores sessionData via `updateSessionData()` and includes in `SESSION_VERSION_UPDATED` broadcast
- `api/oracle.routes.ts`: After V3 submitAppState (losers) and closeSession (winners), stores sessionData via `updateSessionData()` and includes in `SESSION_VERSION_UPDATED` broadcast
- `api/types.ts`: Added `sessionData?: string` to `WsSessionVersionUpdated`

**Simulator changes:**
- `types.ts`: Added `sessionData?: string` to Position and WsSessionVersionUpdated
- `App.tsx`: Added `positionsSelectedIndex` and `positionsExpandedIndex` state. In positions panel: j/k moves cursor (with auto-scroll), Enter/e toggles expansion. SESSION_VERSION_UPDATED handler now stores sessionData.
- `components/PositionsPanel.tsx`: Full rewrite with:
  - `selectedIndex`/`expandedIndex` props
  - Selection indicator (`>`) and inverse highlighting on selected row
  - `SessionDataExpanded` component that parses JSON sessionData:
    - V2: market, outcome, amount, shares, price/share, fee, pre/post-bet odds
    - V3: resolution, result, payout, profit, shares, costPaid
    - Generic fallback for other versions

### Feature 2: Markets overlay panel (`:markets` command)
**Hub changes:**
- `modules/market/manager.ts`: Added `getAllMarkets()` method
- `api/market.routes.ts`: Added `GET /api/markets` endpoint returning all markets

**Simulator changes:**
- `types.ts`: Added `MarketSummary` type
- `core/hub-client.ts`: Added `getMarkets()` and `getMarket(marketId)` methods
- `components/MarketsOverlay.tsx`: NEW — Scrollable market list with j/k navigation, Enter to load, Escape to dismiss. Shows ID, Game, Category, Status, Outcome columns.
- `components/index.ts`: Added MarketsOverlay export
- `components/HelpOverlay.tsx`: Added `:markets` command + `Enter/e` key hint
- `App.tsx`: Added `UIMode = 'markets'`, `marketsList`/`marketsSelectedIndex` state. `:markets` command fetches market list and enters overlay mode. In markets mode: j/k scrolls, Enter loads market data (fetches market + positions, updates all state), Escape dismisses.

### Files Summary
| File | Action |
|---|---|
| `simulator/src/components/HelpOverlay.tsx` | Fix alignment, add `:markets` + `Enter/e` |
| `simulator/src/components/MarketPanel.tsx` | Add results display prop |
| `simulator/src/components/ResultsPanel.tsx` | DELETED |
| `simulator/src/components/PositionsPanel.tsx` | Rewrite with accordion + cursor |
| `simulator/src/components/MarketsOverlay.tsx` | NEW |
| `simulator/src/components/index.ts` | Update exports |
| `simulator/src/App.tsx` | Layout restructure, balance refresh, local results, markets mode, accordion |
| `simulator/src/types.ts` | Add sessionData, MarketSummary, sessionData on WsSessionVersionUpdated |
| `simulator/src/core/hub-client.ts` | Add getMarkets, getMarket |
| `hub/src/db/schema.ts` | Add sessionData column |
| `hub/src/db/connection.ts` | Add session_data to CREATE TABLE SQL |
| `hub/src/modules/position/types.ts` | Add sessionData field |
| `hub/src/modules/position/tracker.ts` | Add updateSessionData method |
| `hub/src/api/bet.routes.ts` | Store V2 sessionData, include in broadcast |
| `hub/src/api/oracle.routes.ts` | Store V3 sessionData, include in broadcast |
| `hub/src/api/types.ts` | Add sessionData to WsSessionVersionUpdated |
| `hub/src/api/market.routes.ts` | Add GET /api/markets |
| `hub/src/modules/market/manager.ts` | Add getAllMarkets() |

### Test Results
- **Hub:** 26 suites, 380 passed (6 skipped — pre-existing Clearnode session tests)
- **Simulator:** 5 suites, 133 passed
- **TypeScript:** Zero compilation errors (both hub and simulator)
- **Total:** 513 passing tests

---

## Frontend UI Redesign (feature/ui-revamp)
Date: 2026-02-07

### What was done:
Complete visual overhaul of the frontend from utilitarian gray to a polished prediction market aesthetic (Polymarket/Kalshi-inspired).

**Implementation in git worktree** at `../pulse-play-ui-revamp` on branch `feature/ui-revamp`.

**Phase 1: Design System Foundation**
- `tailwind.config.ts` — Semantic color tokens: surface (4 shades), border (3), accent (3 green shades), text (3 levels), plus custom fontSize.label
- `globals.css` — CSS vars updated, `@layer components` with `.card`, `.card-header`, `.label`, `.input-field`, `.btn-primary`, `.btn-secondary` utilities, pulse-dot animation, custom scrollbar

**Phase 2: App Shell**
- `LayoutInner.tsx` — `bg-surface`, `flex flex-col`, `max-w-7xl`, added Footer
- `Header.tsx` — Full redesign: `bg-surface-overlay`, font-mono logo + "Beta" badge, pill-style nav, green accent WS status
- `Footer.tsx` — **NEW** — Status bar with version, Yellow Network, year, connected/disconnected status with pulse-dot
- `WalletStatus.tsx` — Green accent connect button, token-based text colors

**Phase 3: Universal Card + Form Pattern Update (26 components)**
- Card backgrounds: `bg-gray-800` → `bg-surface-raised border border-border`
- Headers: `text-lg font-semibold text-white` → `text-sm font-mono uppercase tracking-wider text-text-secondary`
- Labels: gray → `text-text-muted`, inputs → `bg-surface-input border-border focus:border-accent`
- Buttons: blue → green accent, disabled → `disabled:bg-surface-input disabled:text-text-muted`
- All OUTCOME_COLORS, SPORT_COLORS, STATUS_STYLES maps preserved (test-asserted)
- All `bg-white` (selected state), `bg-gray-700` (AdminTabs selected), `border-blue-500` (BetForm) preserved

**Phase 4: Page-Level Updates (6 pages)**
- Titles → `text-2xl font-bold font-mono uppercase tracking-wide text-text-primary`
- Subtitles → `text-text-secondary`
- Home "Active Games" → "Markets"
- Admin panel container → `bg-surface-raised border border-border`
- Skeleton loaders → `bg-surface-input`

**Phase 5: Polish**
- BetResultToast — Added subtle borders (`border-green-400/30` / `border-red-400/30`)
- `Footer.test.tsx` — **NEW** — 3 tests (renders info, connected status, disconnected status)

### Test results:
- **39 test suites passing, 322 tests total** (38 existing + 1 new Footer test)
- Zero test failures — all test-asserted CSS classes preserved

---

## Contrast & Readability Fix (UI Revamp Branch)
Date: 2026-02-07

### What was done:
Token-only fix in `tailwind.config.ts` to improve contrast ratios. No component files touched.

| Token | Old | New | Effect |
|-------|-----|-----|--------|
| `text.muted` | `#484F58` | `#6E7681` | ~3.5:1 on raised (was ~2.1:1). Labels/timestamps now readable. |
| `text.secondary` | `#8B949E` | `#9DA5AE` | ~7.0:1 on raised (was ~5.6:1). Card headers comfortably readable. |
| `accent.DEFAULT` | `#10B981` | `#0FA97E` | Slightly desaturated/darker. Less jarring pop on near-black. |
| `accent.hover` | `#059669` | `#0B8C68` | Proportional adjustment for visible hover feedback. |

### Rationale:
- Raised text floor (muted/secondary brighter) and lowered accent ceiling (green softer)
- Compresses dynamic range for better visual synergy without making things bright
- Token-based approach: 4 values changed propagate to all 26+ components automatically

### Test results:
- **39 test suites passing, 322 tests total** — zero regressions
- No component files touched = zero risk of class-level test failures

---

## 2026-02-07: PositionsPanel V3 Layout + Scroll Fix (feature/dashboard-migration worktree)

### Changes to `packages/simulator/src/components/PositionsPanel.tsx`:

**1. V3 Session Data — one field per line**
- Reformatted V3 Settlement Data section from multi-field-per-row to one-field-per-line
- Each field (resolution, result, payout, profit, shares, costPaid) now gets its own `<Box gap={2}>` row
- Matches the V2 pattern that was already one-field-per-line

**2. Scroll overflow fix — account for expanded rows**
- Added `EXPANDED_LINES = 8` constant (header + 6 data fields + spacing)
- When `expandedIndex` falls within visible range `[scrollOffset, scrollOffset + visibleCount)`, reduces slice to `effectiveCount = visibleCount - EXPANDED_LINES` (min 1)
- `displayPositions`, `endIndex`, and scroll indicator all use `effectiveCount`
- Prevents expanded session data from overflowing the panel's fixed height

### Verification:
- `npx tsc --noEmit` — zero errors
- `pnpm --filter @pulse-play/simulator test` — 133 tests passed, 0 failures

---

## 2026-02-07: Simulator TUI Bug Fixes — Event Log Clearing + Positions Scroll + Session Data Formatting
Worktree: pulse-play-dashboard-migration

### Bug 1: Event log randomly clears
**Root causes identified:**
1. `addEvent` called `setEventLogScrollOffset(Number.MAX_SAFE_INTEGER)` → `events.slice(MAX_SAFE_INTEGER, ...)` → empty array for one frame
2. `processMessage` depended on `outcomes` state → ODDS_UPDATE re-created processMessage ref → message effect re-fired → duplicate events + another MAX_SAFE_INTEGER flash
3. `useWebSocket` used `lastMessage` useState → React batching drops messages arriving in same tick

**Fixes applied:**
- **useWebSocket.ts**: Migrated from `lastMessage` useState to `messageQueueRef + queueVersion` counter pattern (matching dashboard)
- **App.tsx**: Removed `setEventLogScrollOffset(Number.MAX_SAFE_INTEGER)` from `addEvent` — existing clamping effect already auto-scrolls
- **App.tsx**: Added `outcomesRef` (useRef synced via useEffect), replaced `outcomes` reads in `processMessage` with `outcomesRef.current`, removed `outcomes` from deps
- **App.tsx**: Replaced lastMessage effect with queue drain: `messageQueue.current!.splice(0)` loop, deps `[queueVersion, processMessage, addEvent, messageQueue]`
- **EventLog.tsx**: Added defensive offset clamping: `safeOffset = Math.max(0, Math.min(scrollOffset, Math.max(0, events.length - visibleCount)))` before slicing

### Bug 2: Column headers disappear + expanding lower positions "switches pages"
**Root causes:**
1. `positionsVisibleCount = positionsHeight - 5` was off by one — actual overhead is 6 lines (border×2 + title + marginBottom + headers + separator)
2. Expanding a position near end of slice caused `effectiveCount` to shrink, pushing the expanded position outside the visible range

**Fixes applied:**
- **App.tsx**: Changed `positionsHeight - 5` → `positionsHeight - 6`
- **App.tsx**: Expand handler now adjusts `scrollOffset` when selected position falls outside effective range after expansion
- **PositionsPanel.tsx**: Exported `EXPANDED_LINES` constant for use in App.tsx

### Bug 3: Session data formatting — left labels, right values
**Fix applied:**
- **PositionsPanel.tsx**: Added `LABEL_WIDTH=12` and `VALUE_WIDTH=14` constants
- V2 and V3 session data rows now use `label.padEnd(LABEL_WIDTH)` + `value.padStart(VALUE_WIDTH)` for clean aligned columns
- V2 fee row combines fee + percent into one value string before padding

### Files Changed
| File | Changes |
|---|---|
| `src/hooks/useWebSocket.ts` | Queue pattern migration (lastMessage → messageQueueRef + queueVersion) |
| `src/App.tsx` | Queue drain, outcomesRef, remove MAX_SAFE_INTEGER, fix positionsVisibleCount, fix expand handler scroll |
| `src/components/PositionsPanel.tsx` | Export EXPANDED_LINES, reformat V2+V3 session data alignment |
| `src/components/EventLog.tsx` | Defensive offset clamping |

### Verification:
- `npx tsc --noEmit` — zero errors
- `pnpm --filter @pulse-play/simulator test` — 133 tests passed, 0 failures

---

## Simulator: README + HelpOverlay + MarketsOverlay Improvements
Date: 2026-02-07

### Problem
1. `:sim config` lacked usage examples in README and help overlay only said "Show/set sim config" with no key names
2. `:markets` command missing from README admin table
3. `Enter / e` position navigation missing from README navigation table
4. MarketsOverlay table columns misaligned — UUID IDs (36 chars) overflowed 28-char and 16-char column widths

### Changes

**README.md:**
- Added "Usage Examples" section under Simulation Config table with exact `:sim config` syntax
- Added important note about stop→config→start workflow for mid-session changes
- Added `:markets` to Admin command table
- Added `Enter / e` to Navigation table for position expand/collapse

**HelpOverlay.tsx:**
- Changed `:sim config` description to `'View config (or set: key=val ...)'`
- Added `:sim config keys` entry listing all 6 config key names

**MarketsOverlay.tsx:**
- Added `truncateId()` helper: `id.slice(0, 10) + '..'` for long IDs
- Reworked column widths: ID 14, GAME 14, CATEGORY 14, STATUS 12, OUTCOME rest
- Separator widened from 60 to 70 chars
- Both market ID and game ID now truncated cleanly

### Verification
- `npx tsc --noEmit` — zero errors
- `pnpm --filter @pulse-play/simulator test` — 133 tests passed

---

## Database Upgrades Plan: Steps 1-13 Complete
Date: 2026-02-07
Branch: feature/database-upgrades (worktree at ../pulse-play-database-upgrades)

### Summary
Implemented the full 13-step "Database Sophistication + Admin Management + Account Page" plan.

### Hub Backend (Steps 1-6)
1. **Teams table + games schema migration** — new `teams` table in schema.ts, games now use `homeTeamId`/`awayTeamId` FK references instead of plain strings, added `imagePath` column
2. **GameManager updated** — validates team IDs exist and belong to sport, enriches game responses with `homeTeam`/`awayTeam` Team objects via SQL join
3. **File upload infrastructure** — `@fastify/multipart` + `@fastify/static`, `saveUpload()` utility accepting `uploadsDir` param (avoids `import.meta.url` in Jest), serves files at `/uploads/`
4. **Sports & Categories CRUD** — POST/PUT/DELETE endpoints for sports and categories with referential integrity checks
5. **Teams CRUD + logo upload** — full CRUD at `/api/teams`, logo upload via multipart at `/api/teams/:teamId/logo`
6. **Game routes updated** — POST `/api/games` accepts `homeTeamId`/`awayTeamId`, game image upload at `/api/games/:gameId/image`, responses include enriched team objects

### Frontend (Steps 7-13)
7. **UsersPanel + LeaderboardPanel** — added error state with retry, refresh button, `useCallback` for fetch
8. **SportsPanel CRUD UI** — create/edit/delete sports and categories with confirmation dialogs, dynamic outcomes input
9. **TeamsPanel (new)** — sport filter tabs, team list with logos, create/edit/delete, logo upload via file input
10. **GamesPanel updated** — team dropdowns instead of text inputs, sport selector filters teams, team logos in game list
11. **Account page redesign** — UserStatsCard (P&L, win rate, stats grid), SettlementHistoryCard (color-coded table), ActivePositionsCard (positions across all markets), reorganized layout
12. **Frontend types + API** — added Team interface, updated Game interface (homeTeamId/awayTeamId, optional homeTeam/awayTeam objects, imagePath), added CRUD functions for sports, categories, teams, upload helpers
13. **Downstream consumers** — GameSelector.tsx uses team dropdowns, MarketControls.tsx uses team IDs, simulator hub-client updated to homeTeamId/awayTeamId

### Test Updates
- All 9+ test files updated for new Game interface (homeTeamId/awayTeamId/imagePath)
- GameSelector.test.tsx rewritten: getSports/getTeams mocks, selectOptions instead of type
- GamesPanel.test.tsx rewritten: same pattern with team dropdowns
- MarketControls.test.tsx: assertion updated from 'Demo Home'/'Demo Away' to 'nyy'/'bos'
- Simulator hub-client.test.ts: createGame params updated

### Key Technical Decisions
- `ctx.uploadsDir?: string` in AppContext avoids import.meta.url issues in Jest
- saveUpload() accepts uploadsDir as parameter, not import.meta.url
- Game API responses enriched with full Team objects (not just IDs) for frontend convenience
- Team dropdowns use sport filter: `filteredTeams = teams.filter(t => t.sportId === sportId)`

### Verification
- Hub: 28 suites, 431 tests passed (1 skipped — pre-existing)
- Frontend: 39 suites, 322 tests passed
- Simulator: 5 suites, 133 tests passed

---

## Simulator Command Rework + Frontend Account Fixes
Date: 2026-02-07
Branch: feature/database-upgrades (worktree at ../pulse-play-database-upgrades)

### Summary
Reworked simulator commands to separate game creation from market opening, added explicit game/market tracking, built games overlay, fixed WebSocket message isolation, and improved frontend account page.

### Simulator Changes

**1. HubClient API updates (hub-client.ts)**
- Added `getGames(filters?)` → GET /api/games with optional query params
- Added `getTeams(sportId?)` → GET /api/teams with optional filter
- Updated `closeMarket(gameId?, categoryId?)` — passes optional IDs to hub
- Updated `resolveMarket(outcome, gameId?, categoryId?)` — passes optional IDs to hub
- +6 new tests (23 total hub-client tests)

**2. Explicit game/market tracking state (App.tsx)**
- Added `currentGameId` / `currentMarketId` state variables as source of truth
- Added refs (`currentMarketIdRef`, `currentGameIdRef`) for stale closure avoidance
- WebSocket messages filtered by `currentMarketId`:
  - ODDS_UPDATE: Only applies if msg.marketId matches
  - MARKET_STATUS: Only applies if msg.marketId matches
  - POSITION_ADDED: Only tracks positions for current market
  - STATE_SYNC: Only used for connectionCount/sessionCounts (no state overwrite)
  - SESSION_VERSION_UPDATED, SESSION_SETTLED: Applied globally (match by appSessionId)

**3. :create command (NEW)**
- `:create [sportId] [homeTeamId] [awayTeamId]` — defaults: baseball nyy bos
- Creates game → activates → sets as currentGameId → clears market state
- Replaces game creation from old `:open` command

**4. :open reworked — market only**
- `:open [categoryId]` — defaults: pitching
- Requires currentGameId (error: "No game loaded. Use :create or :games first")
- Fetches category outcomes from hub
- Sets currentMarketId from response

**5. :close and :resolve — explicit IDs**
- Both now pass gameId/categoryId from adminState.market or currentGameId
- Prevents hub from acting on wrong global "most recent" market

**6. GamesOverlay (NEW component)**
- Interactive game selection overlay (similar to MarketsOverlay)
- Columns: ID, SPORT, HOME, AWAY, STATUS
- j/k navigation, Enter to load game, Escape to dismiss
- Shows `*` indicator for current game

**7. :games command → overlay**
- Previously dumped to event log; now opens interactive GamesOverlay
- `loadGameFromOverlay(gameId)` sets currentGameId, fetches markets, auto-loads active market

**8. :markets filtered by current game**
- When currentGameId set, filters market list to that game
- MarketsOverlay shows game filter header: "MARKETS FOR GAME: {id} (count)"

**9. HelpOverlay updated**
- New "Game & Market" section with :create and :open (reworked)
- :games description → "Browse games (overlay)"
- :markets description → "Browse markets for current game (overlay)"

### Frontend Changes

**10. UserStatsCard error handling**
- Distinguishes 404 (shows "No activity yet") from other errors (shows error message with retry)
- Uses `ApiError` import from api.ts for `instanceof` check on status
- Added `refreshKey` prop — parent can trigger re-fetch after new activity
- New error state UI with retry button (data-testid="stats-error")
- +8 new tests in UserStatsCard.test.tsx (NEW file)

**11. Account page layout**
- Two-column layout: left (2/3) + right (1/3)
- Left column: UserStatsCard, AccountFaucetCard, SettlementHistoryCard, ActivePositionsCard
- Right column: AccountBalanceCard, SessionCard
- UserStatsCard receives refreshKey from parent (re-fetches after faucet fund)

### New Files
- `simulator/src/components/GamesOverlay.tsx` — interactive game selection overlay
- `frontend/src/components/account/UserStatsCard.test.tsx` — 8 tests

### Modified Files
| File | Changes |
|---|---|
| simulator/src/core/hub-client.ts | +getGames, +getTeams, updated close/resolve sigs |
| simulator/src/core/hub-client.test.ts | +6 tests (23 total) |
| simulator/src/types.ts | +GameSummary type |
| simulator/src/App.tsx | Reworked commands, tracking state, WS filtering, games overlay |
| simulator/src/components/GamesOverlay.tsx | NEW |
| simulator/src/components/MarketsOverlay.tsx | +currentGameId prop, filter header |
| simulator/src/components/HelpOverlay.tsx | Updated command docs |
| simulator/src/components/index.ts | +GamesOverlay export |
| frontend/src/components/account/UserStatsCard.tsx | Error distinction, refreshKey |
| frontend/src/components/account/UserStatsCard.test.tsx | NEW — 8 tests |
| frontend/src/app/account/page.tsx | Two-column layout |

### Test Results
- **Hub:** 28 suites, 431 passed (6 skipped — pre-existing)
- **Frontend:** 40 suites, 330 passed (was 322, +8 new UserStatsCard tests)
- **Simulator:** 5 suites, 139 passed (was 133, +6 new hub-client tests)
- **TypeScript:** Zero compilation errors (simulator + frontend source files)
- **Total:** 900 passing tests

## Five Bug Fixes: User Tracking, Game Broadcasts, Error Messages, Sim Config
Date: 2026-02-07

### Bugs Fixed

1. **Bug 4 & 5 — User tracking never wired in (UserStatsCard empty, Leaderboard empty)**
   - **Root cause:** `userTracker.recordBet()`, `recordWin()`, `recordLoss()` were implemented and tested but never called from route handlers
   - **Fix:** Added `ctx.userTracker.recordBet(address, amount)` in `bet.routes.ts` after successful bet; added `ctx.userTracker.recordWin()` and `recordLoss()` in `oracle.routes.ts` resolution loops
   - **Tests added:** 2 in bet.routes.test.ts, 2 in oracle.routes.test.ts

2. **Bug 1 — Games page doesn't react to new games**
   - **Root cause:** Hub never broadcast WebSocket events when games were created/activated/completed
   - **Fix:** Added `GAME_CREATED` WS type to hub types, broadcast in `game.routes.ts` after create/activate/complete. Updated frontend `GameList.tsx` to listen for `GAME_CREATED`. Added type parity to simulator and frontend types.
   - **Tests added:** 3 in game.routes.test.ts, 1 in GameList.test.tsx

3. **Bug 2 — Simulator error messages show raw JSON**
   - **Root cause:** `hub-client.ts` threw raw response text including JSON wrappers like `{"error":"message"}`
   - **Fix:** Added `extractErrorMessage()` method that parses JSON and extracts `error` or `reason` fields, falling back to raw text
   - **Tests added:** 3 in hub-client.test.ts (JSON error, JSON reason, non-JSON fallback)

4. **Bug 3 — `:sim config keys` says "Config updated"**
   - **Root cause:** `parts[2] === 'keys'` fell into the generic key=val parsing branch
   - **Fix:** Added explicit `keys` check before key=val parsing; also added empty-update detection showing "No valid key=val pairs"

### Modified Files
| File | Changes |
|---|---|
| hub/src/api/bet.routes.ts | +userTracker.recordBet() on accepted bet |
| hub/src/api/oracle.routes.ts | +userTracker.recordWin/recordLoss in resolution |
| hub/src/api/types.ts | +GAME_CREATED WS type |
| hub/src/api/game.routes.ts | +GAME_CREATED broadcast on create/activate/complete |
| hub/src/api/bet.routes.test.ts | +2 user tracking tests |
| hub/src/api/oracle.routes.test.ts | +2 user tracking tests |
| hub/src/api/game.routes.test.ts | +3 GAME_CREATED broadcast tests |
| simulator/src/core/hub-client.ts | extractErrorMessage() for clean errors |
| simulator/src/core/hub-client.test.ts | +3 error extraction tests |
| simulator/src/types.ts | +WsGameCreated type |
| simulator/src/App.tsx | Fixed :sim config keys + empty update detection |
| frontend/src/lib/types.ts | +WsGameCreated type |
| frontend/src/components/games/GameList.tsx | +GAME_CREATED listener |
| frontend/src/components/games/GameList.test.tsx | +1 GAME_CREATED refetch test |

### Test Results
- **Hub:** 26 suites passed, 435 tests (2 pre-existing timeout failures in faucet.test.ts and team.routes.test.ts)
- **Simulator:** 5 suites, 142 tests — all pass
- **Frontend:** 40 suites, 331 tests — all pass
- **Total:** 908 passing tests (+8 from new tests)

## Fix Stale System Panel Data, Game Active Status, and Add `:complete` Command
Date: 2026-02-07

### Bugs Fixed

#### Bug 1: Game ID & Category disappear from System Panel after `:create` + `:open`
- **Root cause:** `:create` sets `adminState.market` to null. `:open` updates `currentMarketId` but never sets `adminState.market` with `gameId`/`categoryId`. Also, `MARKET_STATUS` WS broadcasts didn't include `gameId`/`categoryId`.
- **Fix (Hub):** Added `gameId` and `categoryId` to all three `MARKET_STATUS` broadcasts in `oracle.routes.ts` (open, close, resolve). Updated `WsMarketStatus` type in `types.ts`.
- **Fix (Simulator):** Updated `WsMarketStatus` type. In `:open` command, now sets `adminState.market` immediately with `gameId`/`categoryId`. In `MARKET_STATUS` handler, populates `gameId`/`categoryId` from WS message data on both new and existing market objects.

#### Bug 2: Game active status often incorrect
- **Root cause:** Game activate endpoint only broadcast `GAME_CREATED`, not `GAME_STATE`. Simulator didn't handle `GAME_CREATED`.
- **Fix (Hub):** `game.routes.ts` now broadcasts `GAME_STATE { active: true }` on activate, and `GAME_STATE { active: false }` on complete (only if no other active games remain).
- **Fix (Simulator):** Added `GAME_CREATED` case in `processMessage` (logs event, no state change needed).

### Features Added

#### Feature 1: `:complete` command
- Added `completeGame(gameId)` method to `hub-client.ts`
- Added `case 'complete':` in `App.tsx executeCommand()` — validates `currentGameId`, calls hub, clears game/market context, sets `gameState.active = false`
- Added `:complete` to `HelpOverlay.tsx` command reference

#### Feature 2: Prevent completing games with unresolved markets
- `GameManager` constructor now optionally accepts a `MarketManager`
- `completeGame()` checks all markets for the game; throws if any are not `RESOLVED`
- Wired `MarketManager` into `GameManager` in both `context.ts` (test) and `server.ts` (production)
- Backward compatible: existing code without `MarketManager` skips the check

### Files Modified
| File | Changes |
|---|---|
| `packages/hub/src/api/types.ts` | Added `gameId?`/`categoryId?` to `WsMarketStatus` |
| `packages/hub/src/api/oracle.routes.ts` | Include `gameId`/`categoryId` in all 3 MARKET_STATUS broadcasts |
| `packages/hub/src/api/game.routes.ts` | Broadcast `GAME_STATE` on activate/complete |
| `packages/hub/src/modules/game/manager.ts` | Accept optional `MarketManager`, validate market resolution in `completeGame()` |
| `packages/hub/src/modules/game/manager.test.ts` | +5 tests for market resolution validation |
| `packages/hub/src/context.ts` | Wire `MarketManager` into `GameManager` |
| `packages/hub/src/server.ts` | Wire `MarketManager` into `GameManager` |
| `packages/simulator/src/types.ts` | Added `gameId?`/`categoryId?` to `WsMarketStatus` |
| `packages/simulator/src/App.tsx` | Fix `:open` adminState update, add `:complete` command, handle `GAME_CREATED`, populate gameId/categoryId in MARKET_STATUS handler |
| `packages/simulator/src/core/hub-client.ts` | Added `completeGame()` method |
| `packages/simulator/src/components/HelpOverlay.tsx` | Added `:complete` to help |

### Test Results
- **Hub game manager:** 26 tests pass (21 existing + 5 new market validation tests)
- **Hub oracle routes:** 40 tests pass
- **Simulator:** Type-checks cleanly (tsc --noEmit)
- 2 pre-existing timeout failures in bet.routes.test.ts and game.routes.test.ts (unrelated)

## Fix: Game Status in System Panel Not Updating on Game Load
Date: 2026-02-07

### Problem
The Game ACTIVE/INACTIVE status in the system panel only reacted to `:create` and `:complete` commands. Loading a game via `:games` overlay or `:markets` overlay didn't update the status. `STATE_SYNC` WS messages also dropped `gameState`.

### Root Cause
Three places failed to set `adminState.gameState`:
1. `loadGameFromOverlay` — never set `gameState`, defaulted to previous (or `{ active: false }`)
2. `loadMarketFromOverlay` — same issue, defaulted to `{ active: false }`
3. `STATE_SYNC` handler — explicitly copied only `connectionCount` and `sessionCounts`, dropping `gameState`

### Fix
1. **`loadGameFromOverlay`** — Derives `isActive` from the selected game's `status` field in `gamesList`, sets `gameState: { active: isActive }` in both code paths (with and without active market)
2. **`loadMarketFromOverlay`** — Fetches the game via `hubClient.getGames()` to determine status, sets `gameState` accordingly
3. **`STATE_SYNC` handler** — Now passes through `gameState` from the sync message

### Files Modified
- `packages/simulator/src/App.tsx` — All three fixes above

## P2P CLOB (Central Limit Order Book) Implementation Complete
Date: 2026-02-07

### Overview
Implemented a full P2P order book alongside the existing LMSR market maker for binary markets (outcomes.length === 2). Users submit limit orders with a max cost per share (MCPS), and the hub's matching engine pairs complementary orders on opposite outcomes.

### Steps Completed (11 total):

**Step 1: Hub Schema + Types**
- Added `p2p_orders` and `p2p_fills` tables to DB schema
- Added `mode` column to positions table ('lmsr' | 'p2p')
- Created P2P type definitions (P2POrder, P2PFill, OrderBookDepth, etc.)

**Step 2: Matching Engine (pure function)**
- `matchOrder()` — pairs incoming orders with resting orders when combined MCPS >= 1.00
- Surplus split evenly as price improvement
- 20 tests

**Step 3: OrderBookManager (DB-backed)**
- placeOrder, cancelOrder, getDepth, getOrder, getOrdersByUser, getOrdersByMarket
- getFills, getFilledOrdersForResolution, expireUnfilledOrders, settleOrder
- Atomic transactions for matching + DB updates
- 33 tests

**Step 4: AppContext + WS Types + Logger**
- Added OrderBookManager to AppContext
- Added 5 WS message types (ORDER_PLACED, ORDER_FILLED, ORDERBOOK_UPDATE, ORDER_CANCELLED, P2P_BET_RESULT)
- Added 7 P2P log methods

**Step 5: REST API Routes**
- POST /api/orderbook/order — Place P2P order (validates binary, MCPS range, market status)
- DELETE /api/orderbook/order/:orderId — Cancel order
- GET /api/orderbook/depth/:marketId — Order book depth
- GET /api/orderbook/orders/:address — User's orders
- 25 tests

**Step 6: Resolution Integration**
- P2P resolution block after LMSR loop in oracle.routes.ts
- Losers settled first (MM needs funds), winners get $1/share minus fee
- Unfilled orders expired with full refund
- LMSR positions filtered to mode='lmsr' to prevent double-processing
- 7 tests

**Step 7: Frontend Types + API Client**
- Added P2P types to frontend types.ts
- Added 4 API functions (placeP2POrder, cancelP2POrder, getOrderBookDepth, getUserP2POrders)
- 4 tests

**Step 8: useP2POrder Hook**
- Mirrors useBet pattern: creates Clearnode session, then submits order
- Step tracking: idle → creating-session → submitting-order → idle
- 9 tests

**Step 9: Frontend OrderBook Components**
- OrderBookTable — Two-sided depth display with real-time WS updates
- PlaceOrderForm — Outcome selector, MCPS input with match hint, amount presets, max shares display
- UserOrders — Order list with status badges, fill progress bars, cancel buttons
- P2PResultToast — Win/loss notification subscribing to P2P_BET_RESULT
- 33 tests

**Step 10: Game Detail Page Integration**
- GameBettingArea component with LMSR/OrderBook tab toggle for binary markets
- Non-binary markets show LMSR only (no toggle)
- 6 tests

**Step 11: Simulator Integration**
- HubClient: Added placeP2POrder, cancelP2POrder, getOrderBookDepth, getUserP2POrders
- SimulationEngine: Added P2P mode (mode: 'lmsr' | 'p2p' | 'mixed'), mcpsMin/mcpsMax config
- App.tsx: Added :p2p create|cancel|depth|auto|mixed commands
- Types: Added P2P WS message types, OrderStatus, P2POrder, etc.
- Formatters: Added formatting for 5 new WS message types and 3 P2P sim event colors
- 20 new tests

### Test Summary
- Hub: 530 passed (53 orderbook-specific)
- Frontend: 383 passed (42 orderbook-specific)
- Simulator: 162 passed (20 P2P-specific)
- Total: 1,075 tests passing

### Key Design Decisions
1. P2P uses same Clearnode session model as LMSR — each order creates a session with MM
2. Matching is atomic via DB transaction (SQLite single-writer prevents race conditions)
3. Resolution separates LMSR and P2P paths by position `mode` field
4. Frontend uses tab toggle in GameBettingArea, only shown for binary markets
5. Simulator supports three modes: lmsr (default), p2p, mixed

### Branch
All work on branch `feature/clob` in worktree at `../pulse-play-clob/`
